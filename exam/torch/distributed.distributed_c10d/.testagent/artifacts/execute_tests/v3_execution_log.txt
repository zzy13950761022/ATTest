=== Run Tests ===
F                                                                        [100%]
=================================== FAILURES ===================================
_______ test_async_send_recv_basic_flow[tensor_shape0-float32-cpu-0-1-2] _______

tensor_shape = [4], dtype = 'float32', device = 'cpu', src_rank = 0
dst_rank = 1, world_size = 2
mock_default_group = <MagicMock name='_get_default_group' id='5662880096'>
mock_is_initialized = <MagicMock name='is_initialized' id='5663264384'>
mock_rank_not_in_group = <MagicMock name='_rank_not_in_group' id='5663272448'>
mock_warn_not_in_group = <MagicMock name='_warn_not_in_group' id='5663296960'>
mock_check_single_tensor = <MagicMock name='_check_single_tensor' id='5663305072'>
mock_supports_complex = <MagicMock name='supports_complex' id='5663313200'>
mock_get_group_rank = <MagicMock name='get_group_rank' id='5663321216'>
mock_work = <Mock name='_get_default_group().send()' spec='Work' id='5663362064'>

    @pytest.mark.parametrize(
        "tensor_shape,dtype,device,src_rank,dst_rank,world_size",
        [
            # 基础用例来自测试计划
            ([4], "float32", "cpu", 0, 1, 2),
        ]
    )
    def test_async_send_recv_basic_flow(
        tensor_shape,
        dtype,
        device,
        src_rank,
        dst_rank,
        world_size,
        mock_default_group,
        mock_is_initialized,
        mock_rank_not_in_group,
        mock_warn_not_in_group,
        mock_check_single_tensor,
        mock_supports_complex,
        mock_get_group_rank,
        mock_work
    ):
        """
        TC-05: 异步发送接收基本流程
        验证异步发送和接收的基本功能
        """
        # 创建测试张量
        if dtype == "float32":
            tensor = torch.randn(*tensor_shape, dtype=torch.float32)
        elif dtype == "float64":
            tensor = torch.randn(*tensor_shape, dtype=torch.float64)
        else:
            tensor = torch.randn(*tensor_shape)
    
        # 创建接收张量
        recv_tensor = torch.zeros_like(tensor)
    
        # 获取模拟的进程组
        mock_pg = mock_default_group.return_value
    
        # 模拟send和recv操作
        mock_pg.send.return_value = mock_work
        mock_pg.recv.return_value = mock_work
        mock_pg.recv_anysource.return_value = mock_work
    
        # 模拟get_group_rank返回相同rank
        mock_get_group_rank.return_value = dst_rank
    
        # 测试同步发送
        with patch('torch.distributed.distributed_c10d.send') as mock_send_func:
            mock_send_func.return_value = mock_work
            result = dist.send(tensor, dst_rank)
    
            # weak断言1: 发送已初始化
>           mock_send_func.assert_called_once()

tests/test_torch_distributed_distributed_c10d_g3.py:166: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='send' id='5663362736'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'send' to have been called once. Called 0 times.

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:908: AssertionError
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                                                  Stmts   Miss Branch BrPart  Cover   Missing
-------------------------------------------------------------------------------------------------
tests/test_torch_distributed_distributed_c10d_g3.py     112     41      4      1    62%   89-91, 141-144, 167-231
-------------------------------------------------------------------------------------------------
TOTAL                                                   112     41      4      1    62%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_distributed_distributed_c10d_g3.py::test_async_send_recv_basic_flow[tensor_shape0-float32-cpu-0-1-2]
1 failed in 0.53s

Error: exit 1