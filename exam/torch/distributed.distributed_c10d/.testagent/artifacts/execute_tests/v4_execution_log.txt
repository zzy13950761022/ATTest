=== Run Tests ===
FFEE....FF                                                               [100%]
==================================== ERRORS ====================================
_ ERROR at setup of TestDistributedC10DCollectiveOps.test_all_reduce_basic_operations[tensor_shape0-float32-cpu-SUM-False-2] _

    @pytest.fixture
    def mock_process_group():
        """Mock process group for testing."""
        pg = Mock(spec=dist.ProcessGroup)
        pg.rank.return_value = 0
        pg.size.return_value = 2
>       pg.backend.return_value = "gloo"

tests/test_torch_distributed_distributed_c10d_g2.py:21: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Mock spec='ProcessGroup' id='4532911504'>, name = 'backend'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'backend'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:643: AttributeError
_ ERROR at setup of TestDistributedC10DCollectiveOps.test_broadcast_basic_functionality[tensor_shape0-float32-cpu-0-False-2] _

    @pytest.fixture
    def mock_process_group():
        """Mock process group for testing."""
        pg = Mock(spec=dist.ProcessGroup)
        pg.rank.return_value = 0
        pg.size.return_value = 2
>       pg.backend.return_value = "gloo"

tests/test_torch_distributed_distributed_c10d_g2.py:21: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Mock spec='ProcessGroup' id='4532190128'>, name = 'backend'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'backend'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:643: AttributeError
=================================== FAILURES ===================================
_____________ test_init_process_group_basic[gloo-env://-2-0-1800-] _____________

backend = 'gloo', init_method = 'env://', world_size = 2, rank = 0
timeout_val = 1800, group_name = '', mock_backend_detection = None
cleanup_process_groups = None

    @pytest.mark.parametrize("backend,init_method,world_size,rank,timeout_val,group_name", [
        ("gloo", "env://", 2, 0, 1800, ""),
    ])
    def test_init_process_group_basic(
        backend, init_method, world_size, rank, timeout_val, group_name,
        mock_backend_detection, cleanup_process_groups
    ):
        """
        TC-01: 基本进程组初始化与销毁
        验证进程组可以正常初始化和销毁
        """
        # 模拟环境变量
        with patch.dict(os.environ, {
            "MASTER_ADDR": "localhost",
            "MASTER_PORT": "12345",
            "WORLD_SIZE": str(world_size),
            "RANK": str(rank)
        }):
            # 模拟init_process_group内部调用
            mock_pg = Mock(spec=dist_c10d.ProcessGroup)
            mock_pg.rank.return_value = rank
            mock_pg.size.return_value = world_size
>           mock_pg.backend.return_value = backend

tests/test_torch_distributed_distributed_c10d_g1.py:85: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Mock spec='ProcessGroup' id='4531040560'>, name = 'backend'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'backend'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:643: AttributeError
___________________ test_init_process_group_invalid_backend ____________________

mock_backend_detection = None, cleanup_process_groups = None

    def test_init_process_group_invalid_backend(
        mock_backend_detection, cleanup_process_groups
    ):
        """
        TC-02: 无效backend参数异常
        验证传入无效backend时会抛出RuntimeError
        """
        backend = "invalid_backend"
        init_method = "env://"
        world_size = 2
        rank = 0
        timeout_val = 1800
    
        # 模拟环境变量
        with patch.dict(os.environ, {
            "MASTER_ADDR": "localhost",
            "MASTER_PORT": "12345",
            "WORLD_SIZE": str(world_size),
            "RANK": str(rank)
        }):
            # weak断言1: 异常被抛出
            with pytest.raises(RuntimeError) as exc_info:
>               dist_c10d.init_process_group(
                    backend=backend,
                    init_method=init_method,
                    world_size=world_size,
                    rank=rank,
                    timeout=timedelta(seconds=timeout_val)
                )

tests/test_torch_distributed_distributed_c10d_g1.py:156: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/distributed/distributed_c10d.py:734: in init_process_group
    backend = Backend(backend)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = <class 'torch.distributed.distributed_c10d.Backend'>
name = 'invalid_backend'

    def __new__(cls, name: str):
        if not isinstance(name, string_classes):
            raise ValueError("Backend name must be a string, but got: {}".format(name))
        value = getattr(Backend, name.upper(), Backend.UNDEFINED)
    
        if value == Backend.TCP:
            raise ValueError(
                "TCP backend has been deprecated. Please use "
                "Gloo or MPI backend for collective operations "
                "on CPU tensors."
            )
        elif value == Backend.UNDEFINED:
>           raise ValueError("Invalid backend: '{}'".format(name))
E           ValueError: Invalid backend: 'invalid_backend'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/distributed/distributed_c10d.py:187: ValueError
_ TestDistributedC10DP2PAndUtils.test_async_send_recv_basic_flow[tensor_shape0-float32-cpu-0-1-2] _

self = <test_torch_distributed_distributed_c10d_g3_fixed.TestDistributedC10DP2PAndUtils object at 0x10e1203d0>
tensor_shape = [4], dtype = 'float32', device = 'cpu', src_rank = 0
dst_rank = 1, world_size = 2
mock_default_group = <MagicMock name='_get_default_group' id='4532901088'>
mock_is_initialized = <MagicMock name='is_initialized' id='4532908672'>
mock_rank_not_in_group = <MagicMock name='_rank_not_in_group' id='4531425424'>
mock_warn_not_in_group = <MagicMock name='_warn_not_in_group' id='4531421872'>
mock_check_single_tensor = <MagicMock name='_check_single_tensor' id='4531031344'>
mock_supports_complex = <MagicMock name='supports_complex' id='4530740608'>
mock_get_group_rank = <MagicMock name='get_group_rank' id='4530746992'>
mock_work = <Mock name='_get_default_group().send()' spec='Work' id='4530818064'>

    @pytest.mark.parametrize(
        "tensor_shape,dtype,device,src_rank,dst_rank,world_size",
        [
            # 基础用例来自测试计划
            ([4], "float32", "cpu", 0, 1, 2),
        ]
    )
    def test_async_send_recv_basic_flow(
        self,
        tensor_shape,
        dtype,
        device,
        src_rank,
        dst_rank,
        world_size,
        mock_default_group,
        mock_is_initialized,
        mock_rank_not_in_group,
        mock_warn_not_in_group,
        mock_check_single_tensor,
        mock_supports_complex,
        mock_get_group_rank,
        mock_work
    ):
        """
        TC-05: 异步发送接收基本流程
        验证异步发送和接收的基本功能
        """
        # 创建测试张量
        if dtype == "float32":
            tensor = torch.randn(*tensor_shape, dtype=torch.float32)
        elif dtype == "float64":
            tensor = torch.randn(*tensor_shape, dtype=torch.float64)
        else:
            tensor = torch.randn(*tensor_shape)
    
        # 创建接收张量
        recv_tensor = torch.zeros_like(tensor)
    
        # 获取模拟的进程组
        mock_pg = mock_default_group.return_value
    
        # 模拟send和recv操作
        mock_pg.send.return_value = mock_work
        mock_pg.recv.return_value = mock_work
        mock_pg.recv_anysource.return_value = mock_work
    
        # 模拟get_group_rank返回相同rank
        mock_get_group_rank.return_value = dst_rank
    
        # 测试同步发送
        with patch('torch.distributed.distributed_c10d.send') as mock_send_func:
            mock_send_func.return_value = mock_work
            result = dist.send(tensor, dst_rank)
    
            # weak断言1: 发送已初始化
>           mock_send_func.assert_called_once()

tests/test_torch_distributed_distributed_c10d_g3_fixed.py:173: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='send' id='4530823296'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'send' to have been called once. Called 0 times.

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:908: AssertionError
_______ test_async_send_recv_basic_flow[tensor_shape0-float32-cpu-0-1-2] _______

tensor_shape = [4], dtype = 'float32', device = 'cpu', src_rank = 0
dst_rank = 1, world_size = 2
mock_default_group = <MagicMock name='_get_default_group' id='4530817008'>
mock_is_initialized = <MagicMock name='is_initialized' id='4532885664'>
mock_rank_not_in_group = <MagicMock name='_rank_not_in_group' id='4532883072'>
mock_warn_not_in_group = <MagicMock name='_warn_not_in_group' id='4530811616'>
mock_check_single_tensor = <MagicMock name='_check_single_tensor' id='4530804464'>
mock_supports_complex = <MagicMock name='supports_complex' id='4531948224'>
mock_get_group_rank = <MagicMock name='get_group_rank' id='4531951872'>
mock_work = <Mock name='_get_default_group().send()' spec='Work' id='4532180384'>

    @pytest.mark.parametrize(
        "tensor_shape,dtype,device,src_rank,dst_rank,world_size",
        [
            # 基础用例来自测试计划
            ([4], "float32", "cpu", 0, 1, 2),
        ]
    )
    def test_async_send_recv_basic_flow(
        tensor_shape,
        dtype,
        device,
        src_rank,
        dst_rank,
        world_size,
        mock_default_group,
        mock_is_initialized,
        mock_rank_not_in_group,
        mock_warn_not_in_group,
        mock_check_single_tensor,
        mock_supports_complex,
        mock_get_group_rank,
        mock_work
    ):
        """
        TC-05: 异步发送接收基本流程
        验证异步发送和接收的基本功能
        """
        # 创建测试张量
        if dtype == "float32":
            tensor = torch.randn(*tensor_shape, dtype=torch.float32)
        elif dtype == "float64":
            tensor = torch.randn(*tensor_shape, dtype=torch.float64)
        else:
            tensor = torch.randn(*tensor_shape)
    
        # 创建接收张量
        recv_tensor = torch.zeros_like(tensor)
    
        # 获取模拟的进程组
        mock_pg = mock_default_group.return_value
    
        # 模拟send和recv操作
        mock_pg.send.return_value = mock_work
        mock_pg.recv.return_value = mock_work
        mock_pg.recv_anysource.return_value = mock_work
    
        # 模拟get_group_rank返回相同rank
        mock_get_group_rank.return_value = dst_rank
    
        # 测试同步发送
        with patch('torch.distributed.distributed_c10d.send') as mock_send_func:
            # 模拟send函数返回Work对象
            mock_send_func.return_value = mock_work
    
            # 调用send函数，提供正确的参数
            result = dist.send(tensor, dst_rank, group=None, tag=0)
    
            # weak断言1: 发送已初始化
>           mock_send_func.assert_called_once()

tests/test_torch_distributed_distributed_c10d_g3.py:169: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='send' id='4532179856'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'send' to have been called once. Called 0 times.

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:908: AssertionError
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                                                        Stmts   Miss Branch BrPart  Cover   Missing
-------------------------------------------------------------------------------------------------------
tests/test_torch_distributed_distributed_c10d_g1.py            88     40     24      3    49%   24-28, 33-37, 53->55, 55->57, 57->exit, 87-130, 165-177
tests/test_torch_distributed_distributed_c10d_g2.py           126     84      8      0    31%   22, 27-31, 36-38, 43-45, 50-52, 57-58, 63-64, 69-71, 76-78, 113-160, 192-246
tests/test_torch_distributed_distributed_c10d_g3.py           118     47      4      1    59%   89-91, 141-144, 170-243
tests/test_torch_distributed_distributed_c10d_g3_fixed.py     112     41      4      1    62%   88-90, 148-151, 174-238
-------------------------------------------------------------------------------------------------------
TOTAL                                                         444    212     40      5    50%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_distributed_distributed_c10d_g1.py::test_init_process_group_basic[gloo-env://-2-0-1800-]
FAILED tests/test_torch_distributed_distributed_c10d_g1.py::test_init_process_group_invalid_backend
FAILED tests/test_torch_distributed_distributed_c10d_g3_fixed.py::TestDistributedC10DP2PAndUtils::test_async_send_recv_basic_flow[tensor_shape0-float32-cpu-0-1-2]
FAILED tests/test_torch_distributed_distributed_c10d_g3.py::test_async_send_recv_basic_flow[tensor_shape0-float32-cpu-0-1-2]
ERROR tests/test_torch_distributed_distributed_c10d_g2.py::TestDistributedC10DCollectiveOps::test_all_reduce_basic_operations[tensor_shape0-float32-cpu-SUM-False-2]
ERROR tests/test_torch_distributed_distributed_c10d_g2.py::TestDistributedC10DCollectiveOps::test_broadcast_basic_functionality[tensor_shape0-float32-cpu-0-False-2]
4 failed, 4 passed, 2 errors in 0.88s

Error: exit 1