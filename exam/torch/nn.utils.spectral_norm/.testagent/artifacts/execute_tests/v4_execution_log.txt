=== Run Tests ===
......F                                                                  [100%]
=================================== FAILURES ===================================
______________ TestSpectralNorm.test_invalid_dim_index_exception _______________

self = <test_torch_nn_utils_spectral_norm.TestSpectralNorm object at 0x127cb5f60>

    def test_invalid_dim_index_exception(self):
        """TC-12: 无效dim索引异常处理"""
        # 创建线性层（权重形状为 [20, 10]，即2维）
        linear = nn.Linear(in_features=10, out_features=20)
    
        # 测试 dim 超出权重张量维度范围的情况
        # 线性层权重是2维张量，有效dim索引是0或1（或-1或-2）
        # dim=2 会触发 RuntimeError 因为 permute 操作失败
        with pytest.raises(RuntimeError) as exc_info:
            spectral_norm(
                module=linear,
                name='weight',
                n_power_iterations=1,
                eps=1e-12,
                dim=2  # 无效的dim索引，应该抛出 RuntimeError
            )
    
        # weak 断言检查
        # 1. 检查是否抛出了 RuntimeError
        assert exc_info.type is RuntimeError, f"Should raise RuntimeError for invalid dim index, got {exc_info.type}"
    
        # 2. 检查错误消息是否包含相关信息
        error_msg = str(exc_info.value)
        # RuntimeError 消息通常包含 "permute" 和维度信息
        assert 'permute' in error_msg.lower() or 'dimension' in error_msg.lower() or '2' in error_msg, \
            f"Error message should mention permute/dimension or the value, got: {error_msg}"
    
        # 3. 确保模块没有被修改
        assert hasattr(linear, 'weight'), "Module should still have weight parameter"
        assert hasattr(linear, 'bias'), "Module should still have bias parameter"
        assert not hasattr(linear, 'weight_u'), "Module should not have weight_u buffer"
    
        # 测试负的无效 dim 索引
        linear2 = nn.Linear(in_features=10, out_features=20)
        with pytest.raises(RuntimeError) as exc_info2:
            spectral_norm(
                module=linear2,
                name='weight',
                n_power_iterations=1,
                eps=1e-12,
                dim=-3  # 无效的负dim索引，应该抛出 RuntimeError
            )
    
        # 4. 检查是否抛出了 RuntimeError
        assert exc_info2.type is RuntimeError, f"Should raise RuntimeError for negative invalid dim index, got {exc_info2.type}"
    
        # 5. 检查错误消息是否包含相关信息
        error_msg2 = str(exc_info2.value)
        assert 'permute' in error_msg2.lower() or 'dimension' in error_msg2.lower() or '-3' in error_msg2, \
            f"Error message should mention permute/dimension or the value, got: {error_msg2}"
    
        # 6. 测试有效的负 dim 索引（应该可以正常工作）
        linear3 = nn.Linear(in_features=10, out_features=20)
>       sn_linear3 = spectral_norm(
            module=linear3,
            name='weight',
            n_power_iterations=1,
            eps=1e-12,
            dim=-1  # 有效的负dim索引，对应最后一个维度
        )

tests/test_torch_nn_utils_spectral_norm.py:398: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/utils/spectral_norm.py:282: in spectral_norm
    SpectralNorm.apply(module, name, n_power_iterations, dim, eps)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/utils/spectral_norm.py:133: in apply
    weight_mat = fn.reshape_weight_to_matrix(weight)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <torch.nn.utils.spectral_norm.SpectralNorm object at 0x127cb6260>
weight = Parameter containing:
tensor([[-0.0956,  0.2299, -0.0082,  0.2468,  0.3040, -0.1541, -0.2307,  0.2537,
          0.247...0.2091, -0.1543,  0.1214,  0.2514, -0.0864, -0.1298, -0.2859, -0.1631,
         -0.2769, -0.0724]], requires_grad=True)

    def reshape_weight_to_matrix(self, weight: torch.Tensor) -> torch.Tensor:
        weight_mat = weight
        if self.dim != 0:
            # permute dim to front
>           weight_mat = weight_mat.permute(self.dim,
                                            *[d for d in range(weight_mat.dim()) if d != self.dim])
E           RuntimeError: permute(sparse_coo): number of dimensions in the tensor input does not match the length of the desired ordering of dimensions i.e. input.dim() = 2 is not equal to len(dims) = 3

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/utils/spectral_norm.py:40: RuntimeError
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                                         Stmts   Miss Branch BrPart  Cover   Missing
----------------------------------------------------------------------------------------
cleanup.py                                       3      3      0      0     0%   1-3
test_eps_behavior.py                            29     29      0      0     0%   1-37
tests/test_torch_nn_utils_spectral_norm.py     138     14      2      1    89%   407-431, 438
----------------------------------------------------------------------------------------
TOTAL                                          170     46      2      1    73%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_nn_utils_spectral_norm.py::TestSpectralNorm::test_invalid_dim_index_exception
1 failed, 6 passed in 0.59s

Error: exit 1