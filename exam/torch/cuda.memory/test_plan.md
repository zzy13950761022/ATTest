# torch.cuda.memory 测试计划

## 1. 测试策略
- 单元测试框架：pytest
- 隔离策略：使用 mock 模拟无 CUDA 设备环境、内存分配失败场景和 pynvml 库依赖
- 随机性处理：固定随机种子，控制内存分配序列和测试可重复性
- 设备管理：使用 pytest fixtures 管理 CUDA 设备初始化和清理

## 2. 生成规格摘要（来自 test_plan.json）
- **SMOKE_SET**: CASE_01, CASE_02, CASE_05, CASE_06, CASE_09（共5个核心用例）
- **DEFERRED_SET**: CASE_03, CASE_04, CASE_07, CASE_08, CASE_10, CASE_11, CASE_12（共7个延期用例）
- **group 列表**:
  - G1: 基础内存操作（4个用例）
  - G2: 内存统计与监控（4个用例）
  - G3: 高级功能与异常处理（4个用例）
- **active_group_order**: G1 → G2 → G3
- **断言分级策略**: 首轮使用 weak 断言，最终轮启用 strong 断言
- **预算策略**: 
  - size: S(70-80行), M(80-85行)
  - max_lines: 65-85行
  - max_params: 2-6个参数
  - 5个用例需要 mock

## 3. 数据与边界
- **正常数据集**: 标准形状张量(2x2, 4x4)，常用数据类型(float32, float64, int8)
- **随机生成策略**: 固定种子生成可重复的内存分配模式
- **边界值**: 
  - device=None（使用当前设备）
  - fraction=0 和 fraction=1 的边界处理
  - size=0 的极小分配
  - 极大 size 值的内存分配失败
- **极端形状**: 大尺寸张量(测试内存压力)，小尺寸张量(测试碎片)
- **空输入**: 无内存分配时的统计查询
- **负例与异常场景**:
  - 无效 device 参数
  - fraction 超出 [0,1] 范围
  - 非 CUDA 设备访问
  - 内存不足分配失败
  - pynvml 库缺失异常

## 4. 覆盖映射
| TC_ID | 对应需求/约束 | 覆盖风险点 |
|-------|--------------|-----------|
| TC-01 | 基础内存分配与释放统计 | 内存泄漏检测 |
| TC-02 | empty_cache 缓存清理 | 缓存管理正确性 |
| TC-05 | 内存统计字典结构 | 统计完整性 |
| TC-06 | memory_summary 格式化 | 输出可读性 |
| TC-09 | 分配器直接操作 | 底层API稳定性 |
| TC-03 | 多设备隔离性 | 并发安全性 |
| TC-10 | 进程内存限制 | 资源控制 |
| TC-12 | 异常参数处理 | 错误恢复机制 |

**尚未覆盖的关键风险点**:
- 多线程/多进程并发安全
- 极端内存压力下的行为
- 不同 CUDA 版本兼容性
- 平台特定行为差异
- 实时性能监控准确性