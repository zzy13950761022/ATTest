=== Run Tests ===
.....F..F...F.                                                           [100%]
=================================== FAILURES ===================================
_ TestConvModulesG1.test_parameter_validation_and_exception_handling[same_padding_invalid_stride-3-16-3-1-zeros-same-2-ValueError] _

self = <test_torch_nn_modules_conv_g1.TestConvModulesG1 object at 0x10f39fb20>
test_type = 'same_padding_invalid_stride', in_channels = 3, out_channels = 16
kernel_size = 3, groups = 1, padding_mode = 'zeros', padding = 'same'
stride = 2, expect_error = <class 'ValueError'>, random_seed = 42

    @pytest.mark.parametrize(
        "test_type,in_channels,out_channels,kernel_size,groups,padding_mode,padding,stride,expect_error",
        [
            (
                "invalid_groups",
                8,
                16,
                3,
                3,  # groups=3 不整除 in_channels=8
                "zeros",
                0,
                1,
                ValueError,
            ),
            (
                "invalid_padding_mode",
                3,
                16,
                3,
                1,
                "invalid",  # 无效的padding_mode
                0,
                1,
                ValueError,
            ),
            # Medium优先级扩展：padding='same'时stride!=1的异常
            (
                "same_padding_invalid_stride",
                3,
                16,
                3,
                1,
                "zeros",
                "same",
                2,  # stride=2 与 padding='same' 冲突
                ValueError,
            ),
        ],
    )
    def test_parameter_validation_and_exception_handling(
        self,
        test_type,
        in_channels,
        out_channels,
        kernel_size,
        groups,
        padding_mode,
        padding,
        stride,
        expect_error,
        random_seed,
    ):
        """
        TC-02: 参数验证与异常处理
        包含扩展：padding='same'时stride!=1的异常测试
        """
        # 验证异常被正确抛出
        with pytest.raises(expect_error) as exc_info:
            if test_type == "invalid_groups":
                # groups 不整除 in_channels 的情况
                nn.Conv2d(
                    in_channels=in_channels,
                    out_channels=out_channels,
                    kernel_size=kernel_size,
                    groups=groups,
                )
            elif test_type == "invalid_padding_mode":
                # 无效 padding_mode 的情况
                nn.Conv2d(
                    in_channels=in_channels,
                    out_channels=out_channels,
                    kernel_size=kernel_size,
                    padding_mode=padding_mode,
                )
            elif test_type == "same_padding_invalid_stride":
                # padding='same' 且 stride != 1 的情况
                nn.Conv2d(
                    in_channels=in_channels,
                    out_channels=out_channels,
                    kernel_size=kernel_size,
                    padding=padding,
                    stride=stride,
                )
            else:
                raise ValueError(f"Unknown test_type: {test_type}")
    
        # 验证错误消息包含关键信息
        error_msg = str(exc_info.value).lower()
    
        if test_type == "invalid_groups":
            # 检查错误消息是否提到 groups 或整除性
            assert "groups" in error_msg or "divisible" in error_msg, \
                f"Error message should mention groups or divisibility, got: {error_msg}"
    
            # 验证具体的错误条件
            # groups 应该整除 in_channels 和 out_channels
            if groups > in_channels:
                assert "greater" in error_msg or "exceed" in error_msg, \
                    f"Error message should mention groups exceeding in_channels, got: {error_msg}"
    
        elif test_type == "invalid_padding_mode":
            # 检查错误消息是否提到 padding_mode
            assert "padding_mode" in error_msg or "padding mode" in error_msg, \
                f"Error message should mention padding_mode, got: {error_msg}"
    
            # 检查是否提到了允许的值
            allowed_modes = ["zeros", "reflect", "replicate", "circular"]
            for mode in allowed_modes:
                if mode in error_msg:
                    break
            else:
                # 如果没有提到任何允许的模式，至少应该提到"invalid"或"not supported"
                assert "invalid" in error_msg or "not supported" in error_msg or "not one of" in error_msg, \
                    f"Error message should mention invalid or unsupported, got: {error_msg}"
    
        elif test_type == "same_padding_invalid_stride":
            # 检查错误消息是否提到 padding='same' 和 stride 的关系
            assert "same" in error_msg or "stride" in error_msg, \
                f"Error message should mention 'same' padding or stride, got: {error_msg}"
    
            # 检查是否提到了 stride 必须为 1
>           assert "stride" in error_msg and ("1" in error_msg or "one" in error_msg), \
                f"Error message should mention that stride must be 1 for padding='same', got: {error_msg}"
E           AssertionError: Error message should mention that stride must be 1 for padding='same', got: padding='same' is not supported for strided convolutions
E           assert ('stride' in "padding='same' is not supported for strided convolutions" and ('1' in "padding='same' is not supported for strided convolutions" or 'one' in "padding='same' is not supported for strided convolutions"))

tests/test_torch_nn_modules_conv_g1.py:337: AssertionError
_ TestConvModulesG2.test_conv1d_and_conv3d_basic_functionality[Conv1d-3-16-3-input_shape0-dtype0-cpu-1-0-1-1-True] _

self = <test_torch_nn_modules_conv_g2.TestConvModulesG2 object at 0x126f023b0>
conv_type = 'Conv1d', in_channels = 3, out_channels = 16, kernel_size = 3
input_shape = (2, 3, 32), dtype = torch.float32, device = 'cpu', stride = 1
padding = 0, dilation = 1, groups = 1, bias = True, random_seed = 42

    @pytest.mark.parametrize(
        "conv_type,in_channels,out_channels,kernel_size,input_shape,dtype,device,stride,padding,dilation,groups,bias",
        [
            # 基本测试用例
            (
                "Conv1d",
                3,
                16,
                3,
                (2, 3, 32),
                torch.float32,
                "cpu",
                1,
                0,
                1,
                1,
                True,
            ),
            (
                "Conv3d",
                3,
                16,
                3,
                (2, 3, 16, 16, 16),
                torch.float32,
                "cpu",
                1,
                0,
                1,
                1,
                True,
            ),
            (
                "ConvTranspose2d",
                3,
                16,
                3,
                (2, 3, 16, 16),
                torch.float32,
                "cpu",
                1,
                0,
                1,
                1,
                True,
            ),
            # Conv3d边界条件测试 - 修复行133-135覆盖率缺口
            (
                "Conv3d",
                1,
                1,
                1,
                (1, 1, 4, 4, 4),
                torch.float32,
                "cpu",
                1,
                0,
                1,
                1,
                False,
            ),
            # 非默认参数测试 - 修复分支259->262覆盖率缺口
            (
                "Conv1d",
                4,
                8,
                5,
                (2, 4, 64),
                torch.float32,
                "cpu",
                2,
                2,
                2,
                2,
                False,
            ),
            # CUDA设备测试（如果可用）- 修复分支214->247覆盖率缺口
            (
                "Conv3d",
                2,
                4,
                2,
                (1, 2, 8, 8, 8),
                torch.float32,
                "cuda" if torch.cuda.is_available() else "cpu",
                1,
                1,
                1,
                1,
                True,
            ),
        ],
    )
    def test_conv1d_and_conv3d_basic_functionality(
        self,
        conv_type,
        in_channels,
        out_channels,
        kernel_size,
        input_shape,
        dtype,
        device,
        stride,
        padding,
        dilation,
        groups,
        bias,
        random_seed,
    ):
        """
        TC-03: Conv1d 和 Conv3d 基本功能
        包含扩展：ConvTranspose2d 测试
        修复覆盖率缺口：
        1. Conv3d边界条件测试（行133-135）
        2. CUDA设备条件测试（分支214->247）
        3. 非默认参数条件测试（分支259->262）
        """
        # 跳过CUDA测试如果设备不可用
        if device == "cuda" and not torch.cuda.is_available():
            pytest.skip("CUDA not available")
    
        # 1. 实例化模块
        conv_args = {
            "in_channels": in_channels,
            "out_channels": out_channels,
            "kernel_size": kernel_size,
            "stride": stride,
            "padding": padding,
            "dilation": dilation,
            "groups": groups,
            "bias": bias,
            "dtype": dtype,
        }
    
        if conv_type == "Conv1d":
            conv_module = nn.Conv1d(**conv_args)
        elif conv_type == "Conv3d":
            conv_module = nn.Conv3d(**conv_args)
        elif conv_type == "ConvTranspose2d":
            conv_module = nn.ConvTranspose2d(**conv_args)
        else:
            raise ValueError(f"Unsupported conv_type: {conv_type}")
    
        # 2. 验证模块属性
        assert conv_module is not None, "Module should be instantiated"
        assert conv_module.in_channels == in_channels, f"in_channels should be {in_channels}"
        assert conv_module.out_channels == out_channels, f"out_channels should be {out_channels}"
>       assert conv_module.stride == (stride if conv_type == "Conv1d" else (stride, stride) if conv_type == "ConvTranspose2d" else (stride, stride, stride)), \
            f"stride should be {stride}"
E       AssertionError: stride should be 1
E       assert (1,) == 1
E        +  where (1,) = Conv1d(3, 16, kernel_size=(3,), stride=(1,)).stride

tests/test_torch_nn_modules_conv_g2.py:194: AssertionError
_ TestConvModulesG2.test_conv1d_and_conv3d_basic_functionality[Conv1d-4-8-5-input_shape4-dtype4-cpu-2-2-2-2-False] _

self = <test_torch_nn_modules_conv_g2.TestConvModulesG2 object at 0x126f03130>
conv_type = 'Conv1d', in_channels = 4, out_channels = 8, kernel_size = 5
input_shape = (2, 4, 64), dtype = torch.float32, device = 'cpu', stride = 2
padding = 2, dilation = 2, groups = 2, bias = False, random_seed = 42

    @pytest.mark.parametrize(
        "conv_type,in_channels,out_channels,kernel_size,input_shape,dtype,device,stride,padding,dilation,groups,bias",
        [
            # 基本测试用例
            (
                "Conv1d",
                3,
                16,
                3,
                (2, 3, 32),
                torch.float32,
                "cpu",
                1,
                0,
                1,
                1,
                True,
            ),
            (
                "Conv3d",
                3,
                16,
                3,
                (2, 3, 16, 16, 16),
                torch.float32,
                "cpu",
                1,
                0,
                1,
                1,
                True,
            ),
            (
                "ConvTranspose2d",
                3,
                16,
                3,
                (2, 3, 16, 16),
                torch.float32,
                "cpu",
                1,
                0,
                1,
                1,
                True,
            ),
            # Conv3d边界条件测试 - 修复行133-135覆盖率缺口
            (
                "Conv3d",
                1,
                1,
                1,
                (1, 1, 4, 4, 4),
                torch.float32,
                "cpu",
                1,
                0,
                1,
                1,
                False,
            ),
            # 非默认参数测试 - 修复分支259->262覆盖率缺口
            (
                "Conv1d",
                4,
                8,
                5,
                (2, 4, 64),
                torch.float32,
                "cpu",
                2,
                2,
                2,
                2,
                False,
            ),
            # CUDA设备测试（如果可用）- 修复分支214->247覆盖率缺口
            (
                "Conv3d",
                2,
                4,
                2,
                (1, 2, 8, 8, 8),
                torch.float32,
                "cuda" if torch.cuda.is_available() else "cpu",
                1,
                1,
                1,
                1,
                True,
            ),
        ],
    )
    def test_conv1d_and_conv3d_basic_functionality(
        self,
        conv_type,
        in_channels,
        out_channels,
        kernel_size,
        input_shape,
        dtype,
        device,
        stride,
        padding,
        dilation,
        groups,
        bias,
        random_seed,
    ):
        """
        TC-03: Conv1d 和 Conv3d 基本功能
        包含扩展：ConvTranspose2d 测试
        修复覆盖率缺口：
        1. Conv3d边界条件测试（行133-135）
        2. CUDA设备条件测试（分支214->247）
        3. 非默认参数条件测试（分支259->262）
        """
        # 跳过CUDA测试如果设备不可用
        if device == "cuda" and not torch.cuda.is_available():
            pytest.skip("CUDA not available")
    
        # 1. 实例化模块
        conv_args = {
            "in_channels": in_channels,
            "out_channels": out_channels,
            "kernel_size": kernel_size,
            "stride": stride,
            "padding": padding,
            "dilation": dilation,
            "groups": groups,
            "bias": bias,
            "dtype": dtype,
        }
    
        if conv_type == "Conv1d":
            conv_module = nn.Conv1d(**conv_args)
        elif conv_type == "Conv3d":
            conv_module = nn.Conv3d(**conv_args)
        elif conv_type == "ConvTranspose2d":
            conv_module = nn.ConvTranspose2d(**conv_args)
        else:
            raise ValueError(f"Unsupported conv_type: {conv_type}")
    
        # 2. 验证模块属性
        assert conv_module is not None, "Module should be instantiated"
        assert conv_module.in_channels == in_channels, f"in_channels should be {in_channels}"
        assert conv_module.out_channels == out_channels, f"out_channels should be {out_channels}"
>       assert conv_module.stride == (stride if conv_type == "Conv1d" else (stride, stride) if conv_type == "ConvTranspose2d" else (stride, stride, stride)), \
            f"stride should be {stride}"
E       AssertionError: stride should be 2
E       assert (2,) == 2
E        +  where (2,) = Conv1d(4, 8, kernel_size=(5,), stride=(2,), padding=(2,), dilation=(2,), groups=2, bias=False).stride

tests/test_torch_nn_modules_conv_g2.py:194: AssertionError
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                                     Stmts   Miss Branch BrPart  Cover   Missing
------------------------------------------------------------------------------------
tests/test_torch_nn_modules_conv_g1.py     126      5     44      9    92%   28, 105, 202->exit, 208->212, 300, 313, 324->323, 328, 331->341
tests/test_torch_nn_modules_conv_g2.py     124     23     50     15    77%   28, 166, 188, 207, 213-215, 223, 232, 242-260, 298->331, 378, 381->385, 386, 390, 394-398
------------------------------------------------------------------------------------
TOTAL                                      250     28     94     24    84%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_nn_modules_conv_g1.py::TestConvModulesG1::test_parameter_validation_and_exception_handling[same_padding_invalid_stride-3-16-3-1-zeros-same-2-ValueError]
FAILED tests/test_torch_nn_modules_conv_g2.py::TestConvModulesG2::test_conv1d_and_conv3d_basic_functionality[Conv1d-3-16-3-input_shape0-dtype0-cpu-1-0-1-1-True]
FAILED tests/test_torch_nn_modules_conv_g2.py::TestConvModulesG2::test_conv1d_and_conv3d_basic_functionality[Conv1d-4-8-5-input_shape4-dtype4-cpu-2-2-2-2-False]
3 failed, 11 passed in 0.78s

Error: exit 1