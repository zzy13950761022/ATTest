=== Run Tests ===
EF..FF                                                                   [100%]
==================================== ERRORS ====================================
__________ ERROR at setup of test_github_repository_standard_loading ___________

    @pytest.fixture
    def mock_github_download():
        """Mock GitHub download operations."""
>       with patch('torch.hub._download_url_to_file') as mock_download, \
             patch('torch.hub._git_archive') as mock_git_archive, \
             patch('torch.hub.urlparse') as mock_urlparse:

tests/test_torch_hub_load.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1447: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x132fcc340>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'torch.hub' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/hub.py'> does not have the attribute '_download_url_to_file'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1420: AttributeError
=================================== FAILURES ===================================
___________________________ test_local_path_loading ____________________________

mock_local_hubconf = <function mock_local_hubconf.<locals>.create_mock_model at 0x104a0ecb0>
temp_dir = PosixPath('/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmpten0sh0b')
mock_import_module = <MagicMock name='import_module' id='5150260480'>
mock_trust_repo = {'cache_reload': <MagicMock name='_get_cache_or_reload' id='5150404528'>, 'check_module': <MagicMock name='_check_module_exists' id='5228268992'>}

    def test_local_path_loading(
        mock_local_hubconf,
        temp_dir,
        mock_import_module,
        mock_trust_repo
    ):
        """
        Test local path loading (CASE_02).
    
        This test verifies that torch.hub.load can load a model from a local
        directory path with a valid hubconf.py file.
    
        Weak assertions:
        1. returns_object: Function returns a valid object
        2. is_callable: Returned object is callable (has forward method)
        3. has_expected_attributes: Returned object has expected model attributes
        """
        # Create a local test directory with hubconf.py
        local_repo_dir = temp_dir / 'test_hub_local'
        local_repo_dir.mkdir(parents=True, exist_ok=True)
    
        # Create hubconf.py file with simple_model entry point
        hubconf_content = '''
    import torch.nn as nn
    
    class SimpleModel(nn.Module):
        def __init__(self):
            super().__init__()
            self.linear = nn.Linear(10, 5)
    
        def forward(self, x):
            return self.linear(x)
    
    def simple_model(*args, **kwargs):
        """Factory function for simple_model."""
        return SimpleModel()
    '''
    
        hubconf_file = local_repo_dir / 'hubconf.py'
        hubconf_file.write_text(hubconf_content)
    
        # Setup mock import module to return our mock hubconf
        mock_module = Mock()
        mock_module.simple_model = mock_local_hubconf
        mock_import_module.return_value = mock_module
    
        # Call torch.hub.load with local path
        model = torch.hub.load(
            repo_or_dir=str(local_repo_dir),
            model='simple_model',
            source='local',
            trust_repo=None,
            force_reload=False,
            verbose=True,
            skip_validation=False
        )
    
        # Weak assertion 1: returns_object
        assert model is not None, "torch.hub.load should return a model object"
    
        # Weak assertion 2: is_callable
        # Check that the model has a forward method (is callable)
        assert hasattr(model, 'forward'), "Model should have forward method"
        assert callable(model.forward), "Model.forward should be callable"
    
        # Weak assertion 2.1: Additional callable check - can call forward
        test_input = torch.randn(1, 10)
        output = model.forward(test_input)
        assert output is not None, "Model.forward should return output"
        assert isinstance(output, torch.Tensor), "Output should be a torch.Tensor"
    
        # Weak assertion 3: has_expected_attributes
        # Check for common model attributes
        expected_attrs = ['eval', 'train']
        for attr in expected_attrs:
            assert hasattr(model, attr), f"Model should have {attr} attribute"
    
        # Verify the model has the expected class name
        assert model.__class__.__name__ == "SimpleModel", \
            f"Model should be SimpleModel, got {model.__class__.__name__}"
    
        # Verify mock calls
        # Check that import_module was called with correct path
>       mock_import_module.assert_called_once()

tests/test_torch_hub_load.py:295: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='import_module' id='5150260480'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'import_module' to have been called once. Called 0 times.

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:908: AssertionError
__________________________ test_missing_hubconf_file ___________________________

temp_dir = PosixPath('/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmp90m9_5rx')

    def test_missing_hubconf_file(temp_dir):
        """Test that directory without hubconf.py raises appropriate error."""
        empty_dir = temp_dir / 'empty_dir'
        empty_dir.mkdir(parents=True, exist_ok=True)
    
        with pytest.raises((ImportError, RuntimeError)):
>           torch.hub.load(
                repo_or_dir=str(empty_dir),
                model='test_model',
                source='local'
            )

tests/test_torch_hub_load.py:393: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/hub.py:542: in load
    model = _load_local(repo_or_dir, model, *args, **kwargs)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/hub.py:569: in _load_local
    hub_module = _import_module(MODULE_HUBCONF, hubconf_path)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/hub.py:90: in _import_module
    spec.loader.exec_module(module)
<frozen importlib._bootstrap_external>:879: in exec_module
    ???
<frozen importlib._bootstrap_external>:1016: in get_code
    ???
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_frozen_importlib_external.SourceFileLoader object at 0x137adfa60>
path = '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmp90m9_5rx/empty_dir/hubconf.py'

>   ???
E   FileNotFoundError: [Errno 2] No such file or directory: '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmp90m9_5rx/empty_dir/hubconf.py'

<frozen importlib._bootstrap_external>:1073: FileNotFoundError
______________________ test_nonexistent_model_entrypoint _______________________

mock_import_module = <MagicMock name='import_module' id='5228274896'>

    def test_nonexistent_model_entrypoint(mock_import_module):
        """Test that non-existent model entry point raises appropriate error."""
        mock_module = Mock()
        # Don't add any model entry points
        mock_import_module.return_value = mock_module
    
        with pytest.raises((AttributeError, RuntimeError)):
>           torch.hub.load(
                repo_or_dir='test/repo',
                model='nonexistent_model',
                source='github'
            )

tests/test_torch_hub_load.py:407: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/hub.py:539: in load
    repo_or_dir = _get_cache_or_reload(repo_or_dir, force_reload, trust_repo, "load",
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/hub.py:203: in _get_cache_or_reload
    _validate_not_a_forked_repo(repo_owner, repo_name, ref)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/hub.py:162: in _validate_not_a_forked_repo
    response = json.loads(_read_url(Request(url, headers=headers)))
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/hub.py:145: in _read_url
    with urlopen(url) as r:
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/urllib/request.py:216: in urlopen
    return opener.open(url, data, timeout)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/urllib/request.py:525: in open
    response = meth(req, response)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/urllib/request.py:634: in http_response
    response = self.parent.error(
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/urllib/request.py:563: in error
    return self._call_chain(*args)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/urllib/request.py:496: in _call_chain
    result = func(*args)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <urllib.request.HTTPDefaultErrorHandler object at 0x137b0b850>
req = <urllib.request.Request object at 0x137b0b340>
fp = <http.client.HTTPResponse object at 0x137b0b100>, code = 404
msg = 'Not Found', hdrs = <http.client.HTTPMessage object at 0x137b0ab00>

    def http_error_default(self, req, fp, code, msg, hdrs):
>       raise HTTPError(req.full_url, code, msg, hdrs, fp)
E       urllib.error.HTTPError: HTTP Error 404: Not Found

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/urllib/request.py:643: HTTPError
=============================== warnings summary ===============================
exam/torch_group/hub/tests/test_torch_hub_load.py::test_nonexistent_model_entrypoint
  /opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/hub.py:267: UserWarning: You are about to download and run code from an untrusted repository. In a future release, this won't be allowed. To add the repository to your trusted list, change the command to {calling_fn}(..., trust_repo=False) and a command prompt will appear asking for an explicit confirmation of trust, or load(..., trust_repo=True), which will assume that the prompt is to be answered with 'yes'. You can also use load(..., trust_repo='check') which will only prompt for confirmation if the repo is not already trusted. This will eventually be the default behaviour
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                           Stmts   Miss Branch BrPart  Cover   Missing
--------------------------------------------------------------------------
tests/test_torch_hub_load.py     173     83      6      1    52%   43-52, 61-66, 78-87, 97-102, 147-208, 298-315, 331-344, 349-360, 416-417
--------------------------------------------------------------------------
TOTAL                            173     83      6      1    52%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_hub_load.py::test_local_path_loading - AssertionError...
FAILED tests/test_torch_hub_load.py::test_missing_hubconf_file - FileNotFound...
FAILED tests/test_torch_hub_load.py::test_nonexistent_model_entrypoint - urll...
ERROR tests/test_torch_hub_load.py::test_github_repository_standard_loading
3 failed, 2 passed, 1 warning, 1 error in 2.35s

Error: exit 1