=== Run Tests ===
..s......s..FF                                                           [100%]
=================================== FAILURES ===================================
__________ TestPairwiseDistance.test_pairwise_distance_invalid_inputs __________

self = <test_torch_nn_modules_distance_pairwise.TestPairwiseDistance object at 0x125625e70>

    def test_pairwise_distance_invalid_inputs(self):
        """CASE_05: PairwiseDistance异常输入处理"""
        # Test parameters from test_plan.json
        dtype = torch.float32
        device = "cpu"
        shape = (3, 4)
        p = 2.0
        eps = 1e-6
        keepdim = False
    
        # Create PairwiseDistance module
        pairwise_dist = nn.PairwiseDistance(p=p, eps=eps, keepdim=keepdim)
    
        # Test 1: Shape mismatch - different shapes
        x1 = torch.randn(shape, dtype=dtype, device=device)
        x2 = torch.randn((3, 5), dtype=dtype, device=device)  # Different shape
    
        # Weak assertion: exception should be raised
        with pytest.raises(RuntimeError) as exc_info:
            pairwise_dist(x1, x2)
    
        # Weak assertion: check exception type
        assert "RuntimeError" in str(type(exc_info.value)), \
            f"Expected RuntimeError, got {type(exc_info.value)}"
    
        # Check that error message contains shape mismatch information
        error_msg = str(exc_info.value).lower()
        # Common error messages for shape mismatch
        shape_keywords = ["shape", "size", "dimension", "must match"]
        has_shape_error = any(keyword in error_msg for keyword in shape_keywords)
        assert has_shape_error, \
            f"Error message should mention shape mismatch. Got: {error_msg}"
    
        # Test 2: Different number of dimensions
        x1_2d = torch.randn(shape, dtype=dtype, device=device)
        x2_1d = torch.randn((4,), dtype=dtype, device=device)  # 1D vs 2D
    
>       with pytest.raises(RuntimeError) as exc_info2:
E       Failed: DID NOT RAISE <class 'RuntimeError'>

tests/test_torch_nn_modules_distance_pairwise.py:227: Failed
____________ TestPairwiseDistance.test_pairwise_distance_negative_p ____________

self = <test_torch_nn_modules_distance_pairwise.TestPairwiseDistance object at 0x125626620>

    def test_pairwise_distance_negative_p(self):
        """CASE_06: PairwiseDistance负p值测试"""
        # Test parameters from test_plan.json
        dtype = torch.float32
        device = "cpu"
        shape = (2, 3)
        p = -1.0
        eps = 1e-6
        keepdim = False
    
        # Create test inputs
        x1 = torch.randn(shape, dtype=dtype, device=device)
        x2 = torch.randn(shape, dtype=dtype, device=device)
    
        # Create PairwiseDistance module with negative p
        pairwise_dist = nn.PairwiseDistance(p=p, eps=eps, keepdim=keepdim)
    
        # Forward pass
        result = pairwise_dist(x1, x2)
    
        # Oracle: torch.nn.functional.pairwise_distance
        expected = F.pairwise_distance(x1, x2, p=p, eps=eps, keepdim=keepdim)
    
        # Weak assertions
        # 1. Shape assertion
        assert result.shape == expected.shape, \
            f"Shape mismatch: got {result.shape}, expected {expected.shape}"
    
        # 2. Dtype assertion
        assert result.dtype == expected.dtype, \
            f"Dtype mismatch: got {result.dtype}, expected {expected.dtype}"
    
        # 3. Finite values assertion
        assert torch.all(torch.isfinite(result)), \
            "Result contains non-finite values"
    
        # 4. Approximate equality with oracle (weak assertion)
        rtol = 1e-5
        atol = 1e-6
        assert torch.allclose(result, expected, rtol=rtol, atol=atol), \
            f"Result doesn't match oracle. Max diff: {(result - expected).abs().max().item()}"
    
        # Additional tests for negative p behavior
    
        # Test with different negative p values
        for neg_p in [-0.5, -1.0, -2.0, -3.0]:
            pairwise_dist_neg = nn.PairwiseDistance(p=neg_p, eps=eps, keepdim=keepdim)
            result_neg = pairwise_dist_neg(x1, x2)
            expected_neg = F.pairwise_distance(x1, x2, p=neg_p, eps=eps, keepdim=keepdim)
    
            # Check finite values
            assert torch.all(torch.isfinite(result_neg)), \
                f"Result contains non-finite values for p={neg_p}"
    
            # Check oracle match
            assert torch.allclose(result_neg, expected_neg, rtol=rtol, atol=atol), \
                f"Result doesn't match oracle for p={neg_p}"
    
        # Test with very small eps to see if negative p handles division by zero
        small_eps = 1e-12
        pairwise_dist_small_eps = nn.PairwiseDistance(p=p, eps=small_eps, keepdim=keepdim)
        result_small_eps = pairwise_dist_small_eps(x1, x2)
    
        # Should still be finite
        assert torch.all(torch.isfinite(result_small_eps)), \
            f"Result should be finite even with small eps={small_eps}"
    
        # Test property: negative p should produce positive values (due to eps in denominator)
        # For p = -1, distance = 1/(|x-y| + eps), which should be positive
        assert torch.all(result > 0), \
            f"Negative p should produce positive values. Got min={result.min().item()}"
    
        # Test with identical vectors
        x1_identical = x1.clone()
        x2_identical = x1.clone()  # Same as x1
    
        result_identical = pairwise_dist(x1_identical, x2_identical)
        # When vectors are identical, |x-y| = 0, so distance = 1/eps for p = -1
        expected_identical = 1.0 / eps
>       assert torch.allclose(result_identical,
                             torch.full_like(result_identical, expected_identical),
                             rtol=1e-5, atol=1e-6), \
            f"Identical vectors with p={p} should give 1/eps={expected_identical}, got {result_identical.mean().item()}"
E       AssertionError: Identical vectors with p=-1.0 should give 1/eps=1000000.0, got 3.3333333249174757e-07
E       assert False
E        +  where False = <built-in method allclose of type object at 0x10547a320>(tensor([3.3333e-07, 3.3333e-07]), tensor([1000000., 1000000.]), rtol=1e-05, atol=1e-06)
E        +    where <built-in method allclose of type object at 0x10547a320> = torch.allclose
E        +    and   tensor([1000000., 1000000.]) = <built-in method full_like of type object at 0x10547a320>(tensor([3.3333e-07, 3.3333e-07]), 1000000.0)
E        +      where <built-in method full_like of type object at 0x10547a320> = torch.full_like

tests/test_torch_nn_modules_distance_pairwise.py:338: AssertionError
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                                               Stmts   Miss Branch BrPart  Cover   Missing
----------------------------------------------------------------------------------------------
cleanup.py                                             6      6      4      0     0%   1-8
cleanup_temp.py                                        8      8      4      0     0%   3-18
delete_temp_files.py                                   9      9      4      0     0%   1-10
run_test.py                                            8      8      0      0     0%   1-10
test_dim_behavior.py                                  40     40      0      0     0%   1-49
test_validation.py                                    29     29      8      0     0%   3-52
tests/test_torch_nn_modules_distance_cosine.py       102      1      6      1    98%   300
tests/test_torch_nn_modules_distance_pairwise.py     127     13     14      3    89%   96->102, 169->174, 231-254, 346
----------------------------------------------------------------------------------------------
TOTAL                                                329    114     40      4    63%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_nn_modules_distance_pairwise.py::TestPairwiseDistance::test_pairwise_distance_invalid_inputs
FAILED tests/test_torch_nn_modules_distance_pairwise.py::TestPairwiseDistance::test_pairwise_distance_negative_p
2 failed, 10 passed, 2 skipped in 0.64s

Error: exit 1