=== Run Tests ===
F...                                                                     [100%]
=================================== FAILURES ===================================
__________________ test_inference_mode_basic[cpu-dtype0-True] __________________

device = 'cpu', dtype = torch.float32, mode = True

    @pytest.mark.parametrize("device,dtype,mode", [
        ("cpu", torch.float32, True),
        ("cpu", torch.float32, False),
    ])
    def test_inference_mode_basic(device, dtype, mode):
        """TC-03: inference_mode基础功能
    
        测试inference_mode上下文管理器的基本功能：
        1. mode参数控制推理模式开关
        2. 在推理模式下创建的张量requires_grad=False
        3. 无异常抛出
    
        Weak asserts:
        - requires_grad_correct: 张量requires_grad属性正确
        - mode_parameter_works: mode参数正常工作
        - no_exception: 无异常抛出
    
        Note: 根据规格书，此测试需要mock
        """
        # 记录初始状态
        initial_grad_enabled = torch.is_grad_enabled()
    
        # 创建输入张量
        input_tensor = create_tensor(device=device, dtype=dtype, requires_grad=True)
    
        # 使用mock来验证torch._C._InferenceMode被正确调用
        with patch('torch._C._InferenceMode') as mock_inference_mode:
            # 测试inference_mode上下文
            with torch.inference_mode(mode=mode):
                # 验证InferenceMode被正确实例化
                mock_inference_mode.assert_called_once_with(mode)
    
                # 创建新张量
                output_tensor = input_tensor * 2
    
                # 断言1: 在inference_mode上下文内创建的新张量requires_grad=False
                # 注意：当mode=True时，inference_mode应该禁用梯度
                # 当mode=False时，行为可能不同，但根据文档，inference_mode(mode=False)应该启用梯度
                if mode:
>                   assert not output_tensor.requires_grad, (
                        f"Tensor created in inference_mode(mode={mode}) context should have "
                        f"requires_grad=False, but got {output_tensor.requires_grad}"
                    )
E                   AssertionError: Tensor created in inference_mode(mode=True) context should have requires_grad=False, but got True
E                   assert not True
E                    +  where True = tensor([[ 0.6734,  0.2576,  0.4689,  0.4607],\n        [-2.2457, -0.3727,  4.4164, -1.2760],\n        [ 0.9233,  0.5347,  1.0698,  1.6187]], grad_fn=<MulBackward0>).requires_grad

tests/test_torch_autograd_grad_mode_g2.py:69: AssertionError
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                                        Stmts   Miss Branch BrPart  Cover   Missing
---------------------------------------------------------------------------------------
tests/test_torch_autograd_grad_mode_g2.py      71      8     12      3    84%   20-23, 25->27, 165, 174-176, 202-203
---------------------------------------------------------------------------------------
TOTAL                                          71      8     12      3    84%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_autograd_grad_mode_g2.py::test_inference_mode_basic[cpu-dtype0-True]
1 failed, 3 passed in 0.72s

Error: exit 1