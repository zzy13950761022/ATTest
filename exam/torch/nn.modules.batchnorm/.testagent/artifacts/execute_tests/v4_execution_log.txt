=== Run Tests ===
.....FFF.....FFFF.....FFFF                                               [100%]
=================================== FAILURES ===================================
_____________________ test_batchnorm3d_basic_functionality _____________________

    def test_batchnorm3d_basic_functionality():
        """Test basic functionality for BatchNorm3d.
    
        TC-03: BatchNorm3d基础功能
        Priority: High
        Assertion level: weak
        Group: G1
        """
        # Set random seed for reproducibility
        torch.manual_seed(42)
    
        # Create BatchNorm3d instance with parameters from test plan
        bn = BatchNorm3d(
            num_features=6,
            eps=1e-5,
            momentum=0.1,
            affine=True,
            track_running_stats=True
        )
    
        # Create test input with shape [2, 6, 8, 8, 8] from test plan
        input_tensor = torch.randn(2, 6, 8, 8, 8, dtype=torch.float32)
    
        # Set to training mode
        bn.train()
    
        # Save initial running statistics
        initial_running_mean = bn.running_mean.clone()
        initial_running_var = bn.running_var.clone()
    
        # Forward pass
        output = bn(input_tensor)
    
        # Weak assertions from test plan
        # 1. output_shape
        assert output.shape == input_tensor.shape, \
            f"Output shape {output.shape} != input shape {input_tensor.shape}"
    
        # 2. output_dtype
        assert output.dtype == torch.float32, \
            f"Output dtype {output.dtype} != expected float32"
    
        # 3. running_var_updated
        assert not torch.allclose(bn.running_var, initial_running_var), \
            "running_var should be updated in training mode"
    
        # 4. weight_bias_exist
        assert bn.weight is not None, "weight should exist when affine=True"
        assert bn.bias is not None, "bias should exist when affine=True"
    
        # Additional checks
        # Check that running_mean is also updated
        assert not torch.allclose(bn.running_mean, initial_running_mean), \
            "running_mean should be updated in training mode"
    
        # Check output is finite
        assert torch.isfinite(output).all(), \
            "Output contains non-finite values"
    
        # Check weight and bias shapes
        assert bn.weight.shape == (6,), f"weight shape {bn.weight.shape} != (6,)"
        assert bn.bias.shape == (6,), f"bias shape {bn.bias.shape} != (6,)"
    
        # Test normalization is applied
        # For BatchNorm3d, normalization should be applied per feature
        # across batch and spatial dimensions (dim 0, 2, 3, 4)
        output_reshaped = output.transpose(0, 1).reshape(6, -1)  # [C, N*D*H*W]
    
        for c in range(6):
            feature_values = output_reshaped[c]
            feature_mean = feature_values.mean().item()
            feature_std = feature_values.std().item()
    
            # Check approximate zero mean
            assert abs(feature_mean) < 0.5, \
                f"Feature {c}: mean {feature_mean:.4f} is not close to zero"
    
            # Check approximate unit variance
            assert 0.8 < feature_std < 1.2, \
                f"Feature {c}: std {feature_std:.4f} is not close to 1"
    
        # Test eval mode
        bn.eval()
        eval_output = bn(input_tensor)
    
        # Output shape should still be correct
        assert eval_output.shape == input_tensor.shape, \
            f"Eval output shape {eval_output.shape} != input shape {input_tensor.shape}"
    
        # In eval mode, running stats should not be updated
>       assert torch.allclose(bn.running_mean, initial_running_mean, rtol=1e-4), \
            "running_mean should not change in eval mode"
E       AssertionError: running_mean should not change in eval mode
E       assert False
E        +  where False = <built-in method allclose of type object at 0x104e7a320>(tensor([ 0.0020, -0.0031,  0.0008, -0.0012,  0.0024,  0.0054]), tensor([0., 0., 0., 0., 0., 0.]), rtol=0.0001)
E        +    where <built-in method allclose of type object at 0x104e7a320> = torch.allclose
E        +    and   tensor([ 0.0020, -0.0031,  0.0008, -0.0012,  0.0024,  0.0054]) = BatchNorm3d(6, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True).running_mean

tests/test_torch_nn_modules_batchnorm_g1.py:314: AssertionError
_________________ test_lazy_batchnorm1d_delayed_initialization _________________

    def test_lazy_batchnorm1d_delayed_initialization():
        """Test lazy initialization for LazyBatchNorm1d.
    
        TC-04: 懒加载类延迟初始化
        Priority: Medium
        Assertion level: weak
        Group: G1
        """
        # Set random seed for reproducibility
        torch.manual_seed(42)
    
        # Create LazyBatchNorm1d instance with num_features=-1 (to be inferred)
        lazy_bn = LazyBatchNorm1d(
            eps=1e-5,
            momentum=0.1,
            affine=True,
            track_running_stats=True
        )
    
        # Weak assertions from test plan
        # 1. lazy_initialization_works
        # Initially, num_features should be -1 (uninitialized)
>       assert lazy_bn.num_features == -1, \
            f"Initial num_features should be -1, got {lazy_bn.num_features}"
E       AssertionError: Initial num_features should be -1, got 0
E       assert 0 == -1
E        +  where 0 = LazyBatchNorm1d(0, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True).num_features

tests/test_torch_nn_modules_batchnorm_g1.py:348: AssertionError
__________________________ test_invalid_num_features ___________________________

    def test_invalid_num_features():
        """Test that num_features <= 0 raises appropriate error.
    
        Note: BatchNorm constructors don't validate num_features <= 0,
        but we can test that the module behaves correctly with such values.
        """
        # Test with num_features=0 - this should work but may cause issues later
        bn_zero = BatchNorm1d(num_features=0)
        assert bn_zero.num_features == 0
    
        # Test with num_features=-1 - this should also work
>       bn_negative = BatchNorm1d(num_features=-1)

tests/test_torch_nn_modules_batchnorm_g1.py:453: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/modules/batchnorm.py:133: in __init__
    super(_BatchNorm, self).__init__(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = BatchNorm1d(-1, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
num_features = -1, eps = 1e-05, momentum = 0.1, affine = True
track_running_stats = True, device = None, dtype = None

    def __init__(
        self,
        num_features: int,
        eps: float = 1e-5,
        momentum: float = 0.1,
        affine: bool = True,
        track_running_stats: bool = True,
        device=None,
        dtype=None
    ) -> None:
        factory_kwargs = {'device': device, 'dtype': dtype}
        super(_NormBase, self).__init__()
        self.num_features = num_features
        self.eps = eps
        self.momentum = momentum
        self.affine = affine
        self.track_running_stats = track_running_stats
        if self.affine:
>           self.weight = Parameter(torch.empty(num_features, **factory_kwargs))
E           RuntimeError: Trying to create tensor with negative dimension -1: [-1]

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/modules/batchnorm.py:48: RuntimeError
__________________________ test_invalid_num_features ___________________________

    def test_invalid_num_features():
        """Test that num_features <= 0 raises ValueError."""
>       with pytest.raises(ValueError):
E       Failed: DID NOT RAISE <class 'ValueError'>

tests/test_torch_nn_modules_batchnorm_g2.py:200: Failed
_______________________________ test_invalid_eps _______________________________

    def test_invalid_eps():
        """Test that eps <= 0 raises ValueError."""
>       with pytest.raises(ValueError):
E       Failed: DID NOT RAISE <class 'ValueError'>

tests/test_torch_nn_modules_batchnorm_g2.py:209: Failed
____________________________ test_invalid_momentum _____________________________

    def test_invalid_momentum():
        """Test that momentum outside [0, 1] raises ValueError."""
>       with pytest.raises(ValueError):
E       Failed: DID NOT RAISE <class 'ValueError'>

tests/test_torch_nn_modules_batchnorm_g2.py:218: Failed
_______________________ test_input_dimension_validation ________________________

    def test_input_dimension_validation():
        """Test that input dimensions are validated."""
        bn1d = BatchNorm1d(num_features=10)
        bn2d = BatchNorm2d(num_features=10)
        bn3d = BatchNorm3d(num_features=10)
    
        # BatchNorm1d should accept 2D or 3D input
        input_2d = torch.randn(4, 10)
        input_3d = torch.randn(4, 10, 32)
        output_2d = bn1d(input_2d)
        output_3d = bn1d(input_3d)
        assert output_2d.shape == input_2d.shape
        assert output_3d.shape == input_3d.shape
    
        # BatchNorm2d should reject 2D input
        with pytest.raises(RuntimeError):
>           bn2d(input_2d)

tests/test_torch_nn_modules_batchnorm_g2.py:241: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/modules/module.py:1190: in _call_impl
    return forward_call(*input, **kwargs)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/modules/batchnorm.py:138: in forward
    self._check_input_dim(input)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = BatchNorm2d(10, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
input = tensor([[-0.5197,  1.8524,  1.8365,  2.0741, -0.7373, -0.7687, -0.0512,  1.5986,
          0.2123,  1.1060],
        [...-0.2296],
        [ 1.7335, -1.1168,  0.1869,  1.0334, -1.2218, -0.4378,  1.4290,  0.2306,
         -1.8913,  0.7457]])

    def _check_input_dim(self, input):
        if input.dim() != 4:
>           raise ValueError("expected 4D input (got {}D input)".format(input.dim()))
E           ValueError: expected 4D input (got 2D input)

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/modules/batchnorm.py:410: ValueError
__________________________ test_invalid_num_features ___________________________

    def test_invalid_num_features():
        """Test that num_features <= 0 raises ValueError."""
>       with pytest.raises(ValueError):
E       Failed: DID NOT RAISE <class 'ValueError'>

tests/test_torch_nn_modules_batchnorm_new.py:265: Failed
_______________________________ test_invalid_eps _______________________________

    def test_invalid_eps():
        """Test that eps <= 0 raises ValueError."""
>       with pytest.raises(ValueError):
E       Failed: DID NOT RAISE <class 'ValueError'>

tests/test_torch_nn_modules_batchnorm_new.py:274: Failed
____________________________ test_invalid_momentum _____________________________

    def test_invalid_momentum():
        """Test that momentum outside [0, 1] raises ValueError."""
>       with pytest.raises(ValueError):
E       Failed: DID NOT RAISE <class 'ValueError'>

tests/test_torch_nn_modules_batchnorm_new.py:283: Failed
_______________________ test_input_dimension_validation ________________________

    def test_input_dimension_validation():
        """Test that input dimensions are validated."""
        bn1d = BatchNorm1d(num_features=10)
        bn2d = BatchNorm2d(num_features=10)
        bn3d = BatchNorm3d(num_features=10)
    
        # BatchNorm1d should accept 2D or 3D input
        input_2d = torch.randn(4, 10)
        input_3d = torch.randn(4, 10, 32)
        output_2d = bn1d(input_2d)
        output_3d = bn1d(input_3d)
        assert output_2d.shape == input_2d.shape
        assert output_3d.shape == input_3d.shape
    
        # BatchNorm2d should reject 2D input
        with pytest.raises(RuntimeError):
>           bn2d(input_2d)

tests/test_torch_nn_modules_batchnorm_new.py:306: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/modules/module.py:1190: in _call_impl
    return forward_call(*input, **kwargs)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/modules/batchnorm.py:138: in forward
    self._check_input_dim(input)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = BatchNorm2d(10, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
input = tensor([[-0.5197,  1.8524,  1.8365,  2.0741, -0.7373, -0.7687, -0.0512,  1.5986,
          0.2123,  1.1060],
        [...-0.2296],
        [ 1.7335, -1.1168,  0.1869,  1.0334, -1.2218, -0.4378,  1.4290,  0.2306,
         -1.8913,  0.7457]])

    def _check_input_dim(self, input):
        if input.dim() != 4:
>           raise ValueError("expected 4D input (got {}D input)".format(input.dim()))
E           ValueError: expected 4D input (got 2D input)

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/modules/batchnorm.py:410: ValueError
=============================== warnings summary ===============================
exam/torch_group/nn.modules.batchnorm/tests/test_torch_nn_modules_batchnorm_g1.py::test_lazy_batchnorm1d_delayed_initialization
  /opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/nn/modules/lazy.py:180: UserWarning: Lazy modules are a new feature under heavy development so changes to the API or functionality can happen at any moment.
    warnings.warn('Lazy modules are a new feature under heavy development '

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                                           Stmts   Miss Branch BrPart  Cover   Missing
------------------------------------------------------------------------------------------
cleanup.py                                         7      7      4      0     0%   1-16
cleanup_temp.py                                   10     10      4      0     0%   1-21
direct_test.py                                    67     67      0      0     0%   1-84
execute_test.py                                    8      8      2      0     0%   1-12
final_cleanup.py                                  13     13      4      0     0%   1-26
run_test.py                                        8      8      0      0     0%   1-10
test_num_features.py                              32     32      0      0     0%   1-41
tests/test_torch_nn_modules_batchnorm_g1.py      187     55     12      2    70%   19-20, 25-26, 31-33, 38-52, 119->130, 184->189, 316-320, 352-434, 454-460
tests/test_torch_nn_modules_batchnorm_g2.py       84     18     10      0    79%   19-20, 25-26, 31-33, 38-52, 203-204, 212-213, 221-222, 244-245
tests/test_torch_nn_modules_batchnorm_new.py      97     18     10      2    79%   19-20, 25-26, 31-33, 38-52, 118->129, 182->187, 268-269, 277-278, 286-287, 309-310
------------------------------------------------------------------------------------------
TOTAL                                            513    236     46      4    53%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_nn_modules_batchnorm_g1.py::test_batchnorm3d_basic_functionality
FAILED tests/test_torch_nn_modules_batchnorm_g1.py::test_lazy_batchnorm1d_delayed_initialization
FAILED tests/test_torch_nn_modules_batchnorm_g1.py::test_invalid_num_features
FAILED tests/test_torch_nn_modules_batchnorm_g2.py::test_invalid_num_features
FAILED tests/test_torch_nn_modules_batchnorm_g2.py::test_invalid_eps - Failed...
FAILED tests/test_torch_nn_modules_batchnorm_g2.py::test_invalid_momentum - F...
FAILED tests/test_torch_nn_modules_batchnorm_g2.py::test_input_dimension_validation
FAILED tests/test_torch_nn_modules_batchnorm_new.py::test_invalid_num_features
FAILED tests/test_torch_nn_modules_batchnorm_new.py::test_invalid_eps - Faile...
FAILED tests/test_torch_nn_modules_batchnorm_new.py::test_invalid_momentum - ...
FAILED tests/test_torch_nn_modules_batchnorm_new.py::test_input_dimension_validation
11 failed, 15 passed, 1 warning in 0.74s

Error: exit 1