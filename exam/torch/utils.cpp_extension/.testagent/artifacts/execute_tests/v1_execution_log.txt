=== Run Tests ===
FF                                                                       [100%]
=================================== FAILURES ===================================
_ test_basic_cpp_extension_compilation[test_extension-sources0-extra_cflags0-False-True] _

test_name = 'test_extension', sources = ['test.cpp'], extra_cflags = ['-O2']
verbose = False, is_python_module = True
mock_subprocess = <MagicMock name='run' id='5091498864'>
mock_import_module = <MagicMock name='import_module' id='5090396000'>
mock_tempfile = <MagicMock name='mkdtemp' id='5090404064'>
mock_os_path = <MagicMock name='exists' id='5090510352'>, cleanup_temp_dirs = []
tmp_path = PosixPath('/private/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/pytest-of-zzf1sh/pytest-0/test_basic_cpp_extension_compi0')

    @pytest.mark.parametrize("test_name,sources,extra_cflags,verbose,is_python_module", [
        ("test_extension", ["test.cpp"], ["-O2"], False, True),
    ])
    def test_basic_cpp_extension_compilation(
        test_name, sources, extra_cflags, verbose, is_python_module,
        mock_subprocess, mock_import_module, mock_tempfile, mock_os_path,
        cleanup_temp_dirs, tmp_path
    ):
        """
        测试基本C++扩展编译和加载功能
        """
        # 创建测试源文件
        source_dir = tmp_path / "sources"
        source_dir.mkdir()
    
        for source_file in sources:
            file_path = source_dir / source_file
            file_path.write_text(SIMPLE_CPP_CONTENT)
    
        # 准备源文件路径列表
        source_paths = [str(source_dir / s) for s in sources]
    
        # 调用load函数
        with patch('os.path.exists') as mock_exists:
            mock_exists.return_value = True
    
>           module = load(
                name=test_name,
                sources=source_paths,
                extra_cflags=extra_cflags,
                verbose=verbose,
                is_python_module=is_python_module
            )

tests/test_torch_utils_cpp_extension_g1.py:137: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/utils/cpp_extension.py:1284: in load
    return _jit_compile(
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/utils/cpp_extension.py:1485: in _jit_compile
    if baton.try_acquire():
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <torch.utils.file_baton.FileBaton object at 0x141100820>

    def try_acquire(self):
        '''
        Tries to atomically create a file under exclusive access.
    
        Returns:
            True if the file could be created, else False.
        '''
        try:
>           self.fd = os.open(self.lock_file_path, os.O_CREAT | os.O_EXCL)
E           FileNotFoundError: [Errno 2] No such file or directory: '/Users/zzf1sh/Library/Caches/torch_extensions/py310_cpu/test_extension/lock'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/utils/file_baton.py:29: FileNotFoundError
_ test_mixed_cpp_cuda_extension[cuda_extension-sources0-extra_cuda_cflags0-True-True] _

test_name = 'cuda_extension', sources = ['cuda.cpp', 'kernel.cu']
extra_cuda_cflags = ['-O3'], with_cuda = True, verbose = True
mock_subprocess = <MagicMock name='run' id='4371252176'>
mock_import_module = <MagicMock name='import_module' id='5386536848'>
mock_tempfile = <MagicMock name='mkdtemp' id='5386969696'>
mock_os_path = <MagicMock name='exists' id='5387295792'>
mock_cuda_available = <MagicMock name='is_available' id='5387297280'>
cleanup_temp_dirs = []
tmp_path = PosixPath('/private/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/pytest-of-zzf1sh/pytest-0/test_mixed_cpp_cuda_extension_0')

    @pytest.mark.parametrize("test_name,sources,extra_cuda_cflags,with_cuda,verbose", [
        ("cuda_extension", ["cuda.cpp", "kernel.cu"], ["-O3"], True, True),
    ])
    def test_mixed_cpp_cuda_extension(
        test_name, sources, extra_cuda_cflags, with_cuda, verbose,
        mock_subprocess, mock_import_module, mock_tempfile, mock_os_path,
        mock_cuda_available, cleanup_temp_dirs, tmp_path
    ):
        """
        测试混合C++/CUDA扩展编译功能
        """
        # 创建测试源文件
        source_dir = tmp_path / "sources"
        source_dir.mkdir()
    
        for source_file in sources:
            file_path = source_dir / source_file
            if source_file.endswith('.cu'):
                file_path.write_text(CUDA_CPP_CONTENT)
            else:
                file_path.write_text(SIMPLE_CPP_CONTENT)
    
        # 准备源文件路径列表
        source_paths = [str(source_dir / s) for s in sources]
    
        # 调用load函数
        with patch('os.path.exists') as mock_exists:
            mock_exists.return_value = True
    
>           module = load(
                name=test_name,
                sources=source_paths,
                extra_cuda_cflags=extra_cuda_cflags,
                with_cuda=with_cuda,
                verbose=verbose
            )

tests/test_torch_utils_cpp_extension_g1.py:203: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/utils/cpp_extension.py:1284: in load
    return _jit_compile(
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/utils/cpp_extension.py:1485: in _jit_compile
    if baton.try_acquire():
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <torch.utils.file_baton.FileBaton object at 0x1411be0e0>

    def try_acquire(self):
        '''
        Tries to atomically create a file under exclusive access.
    
        Returns:
            True if the file could be created, else False.
        '''
        try:
>           self.fd = os.open(self.lock_file_path, os.O_CREAT | os.O_EXCL)
E           FileNotFoundError: [Errno 2] No such file or directory: '/Users/zzf1sh/Library/Caches/torch_extensions/py310_cpu/cuda_extension/lock'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/utils/file_baton.py:29: FileNotFoundError
----------------------------- Captured stderr call -----------------------------
Using /Users/zzf1sh/Library/Caches/torch_extensions/py310_cpu as PyTorch extensions root...
=============================== warnings summary ===============================
../../../../../../../../opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/utils/cpp_extension.py:25
  /opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/utils/cpp_extension.py:25: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
    from pkg_resources import packaging  # type: ignore[attr-defined]

../../../../../../../../opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/pkg_resources/__init__.py:3146
  /opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/pkg_resources/__init__.py:3146: DeprecationWarning: Deprecated call to `pkg_resources.declare_namespace('google')`.
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(pkg)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                                         Stmts   Miss Branch BrPart  Cover   Missing
----------------------------------------------------------------------------------------
tests/conftest.py                               43     18      0      0    58%   60, 65, 70-76, 81-86, 91-93
tests/test_torch_utils_cpp_extension_g1.py     104     33     22      2    63%   62-63, 146-169, 212-247, 260
----------------------------------------------------------------------------------------
TOTAL                                          147     51     22      2    62%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_utils_cpp_extension_g1.py::test_basic_cpp_extension_compilation[test_extension-sources0-extra_cflags0-False-True]
FAILED tests/test_torch_utils_cpp_extension_g1.py::test_mixed_cpp_cuda_extension[cuda_extension-sources0-extra_cuda_cflags0-True-True]
2 failed, 2 warnings in 1.07s

Error: exit 1