=== Run Tests ===
FFFFFF..EFFF.FF                                                          [100%]
==================================== ERRORS ====================================
___________________ ERROR at setup of test_state_transitions ___________________
file /Users/zzf1sh/Documents/Project/TestAgent-CLI-main/exam/torch_group/onnx.utils/tests/test_torch_onnx_utils.py, line 399
  def test_state_transitions(mock_globals):
E       fixture 'mock_globals' not found
>       available fixtures: anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, capteesys, cov, doctest_namespace, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, sample_input_tensor, sample_input_tensor_2d, simple_conv_model, simple_linear_model, subtests, temp_onnx_file, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/zzf1sh/Documents/Project/TestAgent-CLI-main/exam/torch_group/onnx.utils/tests/test_torch_onnx_utils.py:399
=================================== FAILURES ===================================
______ test_export_basic_model_to_file[nn.Module-tuple-file-13-True-True] ______

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

model_type = 'nn.Module', args_format = 'tuple', output_target = 'file'
opset_version = 13, export_params = True, do_constant_folding = True
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
simple_conv_model = SimpleConvModel(
  (conv): Conv2d(3, 6, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (pool): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
)
sample_input_tensor = tensor([[ 0.4485,  0.0330,  1.4503],
        [-0.6936,  0.9967,  0.6131]])
sample_input_tensor_2d = tensor([[[[-9.5632e-01, -1.2476e+00, -7.4994e-01, -5.9219e-01,  1.7744e+00,
           -9.2155e-01,  9.6245e-01, -3.37...  7.4018e-01,  1.4162e+00,  6.8340e-01,
           -1.3825e-01,  9.8639e-01, -3.8926e-01,  6.1381e-01, -2.7863e-01]]]])
temp_onnx_file = '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmpq58_70sy.onnx'

    @pytest.mark.parametrize(
        "model_type,args_format,output_target,opset_version,export_params,do_constant_folding",
        [
            # Base case from test plan
            ("nn.Module", "tuple", "file", 13, True, True),
            # Parameter extensions from test plan
            ("nn.Module", "named_tuple", "file", 13, True, False),
            ("nn.Module", "tuple", "file", 7, True, True),
            ("nn.Module", "tuple", "file", 16, False, True),
        ]
    )
    def test_export_basic_model_to_file(
        model_type,
        args_format,
        output_target,
        opset_version,
        export_params,
        do_constant_folding,
        simple_linear_model,
        simple_conv_model,
        sample_input_tensor,
        sample_input_tensor_2d,
        temp_onnx_file,
    ):
        """
        Test basic model export to file with various configurations.
    
        This test covers the core export functionality with different:
        - Model types (nn.Module)
        - Args formats (tuple, named_tuple)
        - Opset versions (7, 13, 16)
        - Export parameters (True/False)
        - Constant folding (True/False)
    
        Weak assertions: file exists, file not empty, no exception.
        """
        # Select model based on type
        if model_type == "nn.Module":
            # Use linear model for 1D input, conv model for 2D input
            if args_format == "tuple":
                model = simple_linear_model
                args = (sample_input_tensor,)
            else:  # named_tuple
                model = simple_conv_model
                args = (sample_input_tensor_2d,)
    
        # Prepare args based on format
        if args_format == "named_tuple":
            # Create args with named parameters
            args = (args[0], {"dummy_param": torch.tensor([1.0])})
    
        # Mock dependencies
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace) as mock_trace, \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph) as mock_graph, \
             mock.patch('io.open', mock.mock_open()) as mock_file:

tests/test_torch_onnx_utils.py:176: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
__ test_export_basic_model_to_file[nn.Module-named_tuple-file-13-True-False] ___

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

model_type = 'nn.Module', args_format = 'named_tuple', output_target = 'file'
opset_version = 13, export_params = True, do_constant_folding = False
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
simple_conv_model = SimpleConvModel(
  (conv): Conv2d(3, 6, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (pool): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
)
sample_input_tensor = tensor([[ 0.1005,  0.2325,  0.7064],
        [ 0.3693, -0.8368, -1.2204]])
sample_input_tensor_2d = tensor([[[[-1.3386e-01, -5.8557e-02,  1.2574e-01, -5.5258e-01,  7.4480e-02,
           -1.4929e-01, -5.5225e-01, -9.34...  4.5689e-01, -6.0341e-01,  4.6268e-01,
            2.4934e-01, -1.7062e-01, -6.1410e-01,  5.3551e-01, -1.6644e+00]]]])
temp_onnx_file = '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmp9ofwhs69.onnx'

    @pytest.mark.parametrize(
        "model_type,args_format,output_target,opset_version,export_params,do_constant_folding",
        [
            # Base case from test plan
            ("nn.Module", "tuple", "file", 13, True, True),
            # Parameter extensions from test plan
            ("nn.Module", "named_tuple", "file", 13, True, False),
            ("nn.Module", "tuple", "file", 7, True, True),
            ("nn.Module", "tuple", "file", 16, False, True),
        ]
    )
    def test_export_basic_model_to_file(
        model_type,
        args_format,
        output_target,
        opset_version,
        export_params,
        do_constant_folding,
        simple_linear_model,
        simple_conv_model,
        sample_input_tensor,
        sample_input_tensor_2d,
        temp_onnx_file,
    ):
        """
        Test basic model export to file with various configurations.
    
        This test covers the core export functionality with different:
        - Model types (nn.Module)
        - Args formats (tuple, named_tuple)
        - Opset versions (7, 13, 16)
        - Export parameters (True/False)
        - Constant folding (True/False)
    
        Weak assertions: file exists, file not empty, no exception.
        """
        # Select model based on type
        if model_type == "nn.Module":
            # Use linear model for 1D input, conv model for 2D input
            if args_format == "tuple":
                model = simple_linear_model
                args = (sample_input_tensor,)
            else:  # named_tuple
                model = simple_conv_model
                args = (sample_input_tensor_2d,)
    
        # Prepare args based on format
        if args_format == "named_tuple":
            # Create args with named parameters
            args = (args[0], {"dummy_param": torch.tensor([1.0])})
    
        # Mock dependencies
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace) as mock_trace, \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph) as mock_graph, \
             mock.patch('io.open', mock.mock_open()) as mock_file:

tests/test_torch_onnx_utils.py:176: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
______ test_export_basic_model_to_file[nn.Module-tuple-file-7-True-True] _______

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

model_type = 'nn.Module', args_format = 'tuple', output_target = 'file'
opset_version = 7, export_params = True, do_constant_folding = True
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
simple_conv_model = SimpleConvModel(
  (conv): Conv2d(3, 6, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (pool): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
)
sample_input_tensor = tensor([[-0.2662,  1.0295,  0.1327],
        [ 1.8114, -1.0315,  1.1471]])
sample_input_tensor_2d = tensor([[[[-0.8443, -0.3292, -0.1140, -0.8452,  0.5263,  0.1255, -1.7527,
            0.7752,  0.2892,  0.3520],
     ...9],
          [ 0.1342, -1.1246, -1.8830,  1.6258, -0.7038,  0.5581,  0.2723,
           -0.4286,  0.8240, -1.3990]]]])
temp_onnx_file = '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmpvxkyu0tc.onnx'

    @pytest.mark.parametrize(
        "model_type,args_format,output_target,opset_version,export_params,do_constant_folding",
        [
            # Base case from test plan
            ("nn.Module", "tuple", "file", 13, True, True),
            # Parameter extensions from test plan
            ("nn.Module", "named_tuple", "file", 13, True, False),
            ("nn.Module", "tuple", "file", 7, True, True),
            ("nn.Module", "tuple", "file", 16, False, True),
        ]
    )
    def test_export_basic_model_to_file(
        model_type,
        args_format,
        output_target,
        opset_version,
        export_params,
        do_constant_folding,
        simple_linear_model,
        simple_conv_model,
        sample_input_tensor,
        sample_input_tensor_2d,
        temp_onnx_file,
    ):
        """
        Test basic model export to file with various configurations.
    
        This test covers the core export functionality with different:
        - Model types (nn.Module)
        - Args formats (tuple, named_tuple)
        - Opset versions (7, 13, 16)
        - Export parameters (True/False)
        - Constant folding (True/False)
    
        Weak assertions: file exists, file not empty, no exception.
        """
        # Select model based on type
        if model_type == "nn.Module":
            # Use linear model for 1D input, conv model for 2D input
            if args_format == "tuple":
                model = simple_linear_model
                args = (sample_input_tensor,)
            else:  # named_tuple
                model = simple_conv_model
                args = (sample_input_tensor_2d,)
    
        # Prepare args based on format
        if args_format == "named_tuple":
            # Create args with named parameters
            args = (args[0], {"dummy_param": torch.tensor([1.0])})
    
        # Mock dependencies
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace) as mock_trace, \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph) as mock_graph, \
             mock.patch('io.open', mock.mock_open()) as mock_file:

tests/test_torch_onnx_utils.py:176: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
_____ test_export_basic_model_to_file[nn.Module-tuple-file-16-False-True] ______

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

model_type = 'nn.Module', args_format = 'tuple', output_target = 'file'
opset_version = 16, export_params = False, do_constant_folding = True
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
simple_conv_model = SimpleConvModel(
  (conv): Conv2d(3, 6, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
  (pool): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
)
sample_input_tensor = tensor([[-1.7534, -1.3003,  0.5800],
        [ 0.0158, -1.6756,  1.0759]])
sample_input_tensor_2d = tensor([[[[-0.4210, -0.6637,  1.4599, -1.9324,  0.2951,  1.9531,  0.0623,
           -1.1079, -0.0518,  0.4115],
     ...7],
          [ 1.5941,  2.5384, -0.4962,  1.5591, -1.2024, -0.6351,  0.2057,
            1.2085, -1.2975, -1.7842]]]])
temp_onnx_file = '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmp939ruaax.onnx'

    @pytest.mark.parametrize(
        "model_type,args_format,output_target,opset_version,export_params,do_constant_folding",
        [
            # Base case from test plan
            ("nn.Module", "tuple", "file", 13, True, True),
            # Parameter extensions from test plan
            ("nn.Module", "named_tuple", "file", 13, True, False),
            ("nn.Module", "tuple", "file", 7, True, True),
            ("nn.Module", "tuple", "file", 16, False, True),
        ]
    )
    def test_export_basic_model_to_file(
        model_type,
        args_format,
        output_target,
        opset_version,
        export_params,
        do_constant_folding,
        simple_linear_model,
        simple_conv_model,
        sample_input_tensor,
        sample_input_tensor_2d,
        temp_onnx_file,
    ):
        """
        Test basic model export to file with various configurations.
    
        This test covers the core export functionality with different:
        - Model types (nn.Module)
        - Args formats (tuple, named_tuple)
        - Opset versions (7, 13, 16)
        - Export parameters (True/False)
        - Constant folding (True/False)
    
        Weak assertions: file exists, file not empty, no exception.
        """
        # Select model based on type
        if model_type == "nn.Module":
            # Use linear model for 1D input, conv model for 2D input
            if args_format == "tuple":
                model = simple_linear_model
                args = (sample_input_tensor,)
            else:  # named_tuple
                model = simple_conv_model
                args = (sample_input_tensor_2d,)
    
        # Prepare args based on format
        if args_format == "named_tuple":
            # Create args with named parameters
            args = (args[0], {"dummy_param": torch.tensor([1.0])})
    
        # Mock dependencies
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace) as mock_trace, \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph) as mock_graph, \
             mock.patch('io.open', mock.mock_open()) as mock_file:

tests/test_torch_onnx_utils.py:176: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
_____ test_export_model_to_bytesio[nn.Module-tensor-bytesio-13-True-True] ______

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

model_type = 'nn.Module', args_format = 'tensor', output_target = 'bytesio'
opset_version = 13, export_params = True, do_constant_folding = True
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
sample_input_tensor = tensor([[-0.7328,  0.0113,  0.4797],
        [-0.0365,  1.0878, -0.0177]])

    @pytest.mark.parametrize(
        "model_type,args_format,output_target,opset_version,export_params,do_constant_folding",
        [
            # Base case from test plan
            ("nn.Module", "tensor", "bytesio", 13, True, True),
            # Parameter extension from test plan
            ("ScriptFunction", "tensor", "bytesio", 13, True, True),
        ]
    )
    def test_export_model_to_bytesio(
        model_type,
        args_format,
        output_target,
        opset_version,
        export_params,
        do_constant_folding,
        simple_linear_model,
        sample_input_tensor,
    ):
        """
        Test model export to BytesIO buffer with various configurations.
    
        This test covers:
        - Export to in-memory buffer (BytesIO)
        - Tensor args format
        - Different model types (nn.Module, ScriptFunction)
    
        Weak assertions: buffer not empty, buffer position changed, no exception.
        """
        # Prepare model based on type
        if model_type == "nn.Module":
            model = simple_linear_model
            # For ScriptFunction mock, we'll create a traced version
            script_function_mock = None
        else:  # ScriptFunction
            # Create a mock ScriptFunction
            model = mock.MagicMock(spec=torch.jit.ScriptFunction)
            # Also create a regular model for the trace mock to return
            script_function_mock = simple_linear_model
    
        # Prepare args based on format
        if args_format == "tensor":
            args = sample_input_tensor
    
        # Create BytesIO buffer
        buffer = io.BytesIO()
    
        # Track initial buffer state
        initial_position = buffer.tell()
    
        # Mock dependencies
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace) as mock_trace, \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph) as mock_graph:

tests/test_torch_onnx_utils.py:272: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
___ test_export_model_to_bytesio[ScriptFunction-tensor-bytesio-13-True-True] ___

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

model_type = 'ScriptFunction', args_format = 'tensor', output_target = 'bytesio'
opset_version = 13, export_params = True, do_constant_folding = True
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
sample_input_tensor = tensor([[-0.6039, -0.3514,  0.5235],
        [ 0.0675, -0.9669, -0.0743]])

    @pytest.mark.parametrize(
        "model_type,args_format,output_target,opset_version,export_params,do_constant_folding",
        [
            # Base case from test plan
            ("nn.Module", "tensor", "bytesio", 13, True, True),
            # Parameter extension from test plan
            ("ScriptFunction", "tensor", "bytesio", 13, True, True),
        ]
    )
    def test_export_model_to_bytesio(
        model_type,
        args_format,
        output_target,
        opset_version,
        export_params,
        do_constant_folding,
        simple_linear_model,
        sample_input_tensor,
    ):
        """
        Test model export to BytesIO buffer with various configurations.
    
        This test covers:
        - Export to in-memory buffer (BytesIO)
        - Tensor args format
        - Different model types (nn.Module, ScriptFunction)
    
        Weak assertions: buffer not empty, buffer position changed, no exception.
        """
        # Prepare model based on type
        if model_type == "nn.Module":
            model = simple_linear_model
            # For ScriptFunction mock, we'll create a traced version
            script_function_mock = None
        else:  # ScriptFunction
            # Create a mock ScriptFunction
            model = mock.MagicMock(spec=torch.jit.ScriptFunction)
            # Also create a regular model for the trace mock to return
            script_function_mock = simple_linear_model
    
        # Prepare args based on format
        if args_format == "tensor":
            args = sample_input_tensor
    
        # Create BytesIO buffer
        buffer = io.BytesIO()
    
        # Track initial buffer state
        initial_position = buffer.tell()
    
        # Mock dependencies
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace) as mock_trace, \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph) as mock_graph:

tests/test_torch_onnx_utils.py:272: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
___________ TestONNXUtilsExport.test_export_with_default_parameters ____________

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

self = <test_torch_onnx_utils.TestONNXUtilsExport object at 0x11fef21d0>
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
sample_input_tensor = tensor([[-0.0280, -0.4115,  0.8032],
        [-0.9688,  0.1715, -0.5394]])
temp_onnx_file = '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmprdr605y6.onnx'

    def test_export_with_default_parameters(self, simple_linear_model, sample_input_tensor, temp_onnx_file):
        """Test export with minimal required parameters."""
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace), \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph), \
             mock.patch('io.open', mock.mock_open()):

tests/test_torch_onnx_utils.py:472: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
________ TestONNXUtilsExport.test_export_with_custom_input_output_names ________

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

self = <test_torch_onnx_utils.TestONNXUtilsExport object at 0x11fef2500>
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
sample_input_tensor = tensor([[ 0.4123, -0.2202, -1.7519],
        [-0.2982, -1.6451, -0.6181]])
temp_onnx_file = '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmpzb0pdcb7.onnx'

    def test_export_with_custom_input_output_names(self, simple_linear_model, sample_input_tensor, temp_onnx_file):
        """Test export with custom input and output names."""
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace), \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph), \
             mock.patch('io.open', mock.mock_open()):

tests/test_torch_onnx_utils.py:485: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
______________ TestONNXUtilsExport.test_export_with_verbose_mode _______________

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

self = <test_torch_onnx_utils.TestONNXUtilsExport object at 0x11fef1ff0>
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
sample_input_tensor = tensor([[ 0.7818, -1.0138, -2.0971],
        [ 0.1009,  0.6100,  1.4594]])
temp_onnx_file = '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmpcgt_i8h3.onnx'

    def test_export_with_verbose_mode(self, simple_linear_model, sample_input_tensor, temp_onnx_file):
        """Test export with verbose mode enabled."""
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace), \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph), \
             mock.patch('io.open', mock.mock_open()):

tests/test_torch_onnx_utils.py:499: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
________ TestONNXUtilsEdgeCases.test_export_with_invalid_opset_version _________

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

self = <test_torch_onnx_utils.TestONNXUtilsEdgeCases object at 0x11fef1150>
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
sample_input_tensor = tensor([[ 1.4992, -0.8898,  1.4786],
        [-0.5896,  1.9454,  0.3652]])
temp_onnx_file = '/var/folders/fc/ny_p_wjs10xfzq7xns_lfdc40000gn/T/tmp4ufwx7l4.onnx'

    def test_export_with_invalid_opset_version(self, simple_linear_model, sample_input_tensor, temp_onnx_file):
        """Test export with invalid opset version."""
>       with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace), \
             mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph), \
             mock.patch('io.open', mock.mock_open()):

tests/test_torch_onnx_utils.py:530: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
_________ TestONNXUtilsEdgeCases.test_export_to_nonexistent_directory __________

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
>           return getattr(thing, comp)
E           AttributeError: module 'torch.onnx' has no attribute '_internals'. Did you mean: '_internal'?

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1248: AttributeError

During handling of the above exception, another exception occurred:

self = <test_torch_onnx_utils.TestONNXUtilsEdgeCases object at 0x11fef2680>
simple_linear_model = SimpleLinearModel(
  (linear): Linear(in_features=3, out_features=2, bias=True)
)
sample_input_tensor = tensor([[ 0.2328, -1.2158,  2.8345],
        [-0.3159, -0.1452, -0.8379]])

    def test_export_to_nonexistent_directory(self, simple_linear_model, sample_input_tensor):
        """Test export to non-existent directory."""
        invalid_path = "/nonexistent/path/model.onnx"
    
        # This should raise an error when trying to open the file
        with pytest.raises((OSError, IOError, FileNotFoundError)):
>           with mock.patch('torch.jit.trace', side_effect=mock_torch_jit_trace), \
                 mock.patch('torch.onnx._internals._model_to_graph', side_effect=mock_model_to_graph):

tests/test_torch_onnx_utils.py:554: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1431: in __enter__
    self.target = self.getter()
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1618: in <lambda>
    getter = lambda: _importer(target)
/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1261: in _importer
    thing = _dot_lookup(thing, comp, import_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

thing = <module 'torch.onnx' from '/opt/anaconda3/envs/testagent-experiment/lib/python3.10/site-packages/torch/onnx/__init__.py'>
comp = '_internals', import_path = 'torch.onnx._internals'

    def _dot_lookup(thing, comp, import_path):
        try:
            return getattr(thing, comp)
        except AttributeError:
>           __import__(import_path)
E           ModuleNotFoundError: No module named 'torch.onnx._internals'

/opt/anaconda3/envs/testagent-experiment/lib/python3.10/unittest/mock.py:1250: ModuleNotFoundError
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                             Stmts   Miss Branch BrPart  Cover   Missing
----------------------------------------------------------------------------
tests/test_torch_onnx_utils.py     224     97     28      3    56%   30, 41-43, 77->exit, 83-96, 102-108, 113-114, 119-120, 161->171, 181-215, 262->266, 276-331, 391-392, 477, 489, 504-506, 535-546, 557, 567, 575-586, 591-599, 605-611
----------------------------------------------------------------------------
TOTAL                              224     97     28      3    56%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_onnx_utils.py::test_export_basic_model_to_file[nn.Module-tuple-file-13-True-True]
FAILED tests/test_torch_onnx_utils.py::test_export_basic_model_to_file[nn.Module-named_tuple-file-13-True-False]
FAILED tests/test_torch_onnx_utils.py::test_export_basic_model_to_file[nn.Module-tuple-file-7-True-True]
FAILED tests/test_torch_onnx_utils.py::test_export_basic_model_to_file[nn.Module-tuple-file-16-False-True]
FAILED tests/test_torch_onnx_utils.py::test_export_model_to_bytesio[nn.Module-tensor-bytesio-13-True-True]
FAILED tests/test_torch_onnx_utils.py::test_export_model_to_bytesio[ScriptFunction-tensor-bytesio-13-True-True]
FAILED tests/test_torch_onnx_utils.py::TestONNXUtilsExport::test_export_with_default_parameters
FAILED tests/test_torch_onnx_utils.py::TestONNXUtilsExport::test_export_with_custom_input_output_names
FAILED tests/test_torch_onnx_utils.py::TestONNXUtilsExport::test_export_with_verbose_mode
FAILED tests/test_torch_onnx_utils.py::TestONNXUtilsEdgeCases::test_export_with_invalid_opset_version
FAILED tests/test_torch_onnx_utils.py::TestONNXUtilsEdgeCases::test_export_to_nonexistent_directory
ERROR tests/test_torch_onnx_utils.py::test_state_transitions
11 failed, 3 passed, 1 error in 1.65s

Error: exit 1