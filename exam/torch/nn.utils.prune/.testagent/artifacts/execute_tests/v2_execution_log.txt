=== Run Tests ===
.F.                                                                      [100%]
=================================== FAILURES ===================================
_____________ TestPruneBasic.test_l1_unstructured_validation[5-5] ______________

self = <test_torch_nn_utils_prune.TestPruneBasic object at 0x1350005e0>
conv2d_module = Conv2d(3, 16, kernel_size=(3, 3), stride=(1, 1))
set_random_seed = 42, amount = 5, expected_pruned = 5

    @pytest.mark.parametrize("amount,expected_pruned", [
        (5, 5),  # 绝对数量5个参数
    ])
    def test_l1_unstructured_validation(self, conv2d_module, set_random_seed, amount, expected_pruned):
        """Test L1 unstructured pruning with absolute amount."""
        # Arrange
        module = conv2d_module
        param_name = "weight"
        original_weight = module.weight.clone()
    
        # We need to set weights with predictable absolute values
        # L1剪枝基于绝对值，所以我们需要确保绝对值有明确的顺序
        with torch.no_grad():
            # Create weights with predictable absolute values
            # We'll use positive values only to avoid sign confusion
            flat_weights = original_weight.view(-1)
            for i in range(len(flat_weights)):
                # Use values from 0.0 to 0.9 in order
                flat_weights[i] = i * 0.1  # Values: 0.0, 0.1, 0.2, ..., 0.9, 0.0, 0.1, ...
    
        # Act
        pruned_module = prune.l1_unstructured(module, param_name, amount)
    
        # Assert - weak assertions
        # 1. mask_shape: 掩码形状正确
        mask_name = f"{param_name}_mask"
        assert hasattr(pruned_module, mask_name), f"Mask buffer {mask_name} should exist"
        mask = getattr(pruned_module, mask_name)
        assert mask.shape == original_weight.shape, f"Mask shape {mask.shape} should match weight shape {original_weight.shape}"
    
        # 2. mask_dtype: 掩码数据类型正确
        assert mask.dtype == torch.float32, f"Mask dtype should be float32, got {mask.dtype}"
    
        # 3. prune_count_correct: 剪枝数量正确
        pruned_count = torch.sum(mask == 0).item()
        assert pruned_count == expected_pruned, \
            f"Pruned count {pruned_count} should equal expected {expected_pruned}"
    
        # 4. module_modified: 模块被修改
        assert pruned_module is module, "Function should return the modified module"
    
        # 5. l1_order: 检查L1顺序 - 修改断言以适应实际实现
        # L1剪枝应该剪掉绝对值最小的参数
        # 在我们的设置中，绝对值就是值本身（因为都是正数）
        mask_flat = mask.view(-1)
        zero_indices = torch.where(mask_flat == 0)[0]
        if len(zero_indices) > 0:
            # 检查被剪枝的索引是否对应最小的值
            # 由于我们的值是 i*0.1，所以索引0,1,2,3,4应该是最小的
            # 但我们只检查被剪枝的索引都在前expected_pruned*2范围内
            # 这是因为可能有重复的值（0.0, 0.1, ... 0.9, 0.0, ...）
            max_expected_index = expected_pruned * 2  # 宽松检查
>           assert torch.all(zero_indices < max_expected_index), \
                f"Pruned indices {zero_indices} should be among the smallest values"
E           AssertionError: Pruned indices tensor([105, 181, 221, 252, 369]) should be among the smallest values
E           assert tensor(False)
E            +  where tensor(False) = <built-in method all of type object at 0x107452320>(tensor([105, 181, 221, 252, 369]) < 10)
E            +    where <built-in method all of type object at 0x107452320> = torch.all

tests/test_torch_nn_utils_prune.py:152: AssertionError
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.19-final-0 _______________

Name                                 Stmts   Miss Branch BrPart  Cover   Missing
--------------------------------------------------------------------------------
tests/test_torch_nn_utils_prune.py     125     18     28      9    78%   92->96, 93->92, 156-174, 195, 219-221, 229, 252->256, 253->252, 311
--------------------------------------------------------------------------------
TOTAL                                  125     18     28      9    78%
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_torch_nn_utils_prune.py::TestPruneBasic::test_l1_unstructured_validation[5-5]
1 failed, 2 passed in 0.61s

Error: exit 1