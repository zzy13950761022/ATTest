# torch.nn.utils.prune 测试计划

## 1. 测试策略
- 单元测试框架：pytest
- 隔离策略：mock随机函数和Tensor操作，使用fixtures管理模块实例
- 随机性处理：固定随机种子保证可重复性，控制RNG状态
- 设备支持：优先CPU测试，CUDA作为扩展参数

## 2. 生成规格摘要（来自 test_plan.json）
- **SMOKE_SET**: CASE_01（随机非结构化基础）、CASE_02（L1非结构化）、CASE_03（结构化剪枝）、CASE_08（全局剪枝）
- **DEFERRED_SET**: CASE_04-07、CASE_09-10（边界条件、高级功能）
- **group列表**: G1（基础函数）、G2（结构化剪枝）、G3（高级功能）
- **active_group_order**: G1 → G2 → G3
- **断言分级策略**: 首轮仅使用weak断言（形状、类型、基本属性），后续启用strong断言（精确计算、独立性）
- **预算策略**: 
  - S级：≤80行，≤6参数
  - M级：≤90行，≤8参数  
  - L级：≤100行，≤8参数
- **迭代策略**: 首轮5个SMOKE用例，后续仅修复失败块，最终启用strong断言

## 3. 数据与边界
- **正常数据集**: Linear/Conv2d模块，形状[2,2]到[32,16,3,3]，float32/float64类型
- **随机生成策略**: 固定种子生成参数，验证随机剪枝可重复性
- **边界值**: amount=0（无剪枝）、amount=1.0（完全剪枝）、amount=int（绝对数量）
- **极端形状**: 1D bias参数、4D卷积权重、大形状内存检查
- **空输入**: 空参数列表异常、None类型错误
- **负例场景**: amount负值、超出范围float、无效dim维度、形状不匹配importance_scores
- **异常场景**: 结构化剪枝应用于1D张量、全局剪枝使用结构化方法、无效参数名

## 4. 覆盖映射
| TC ID | 需求覆盖 | 关键约束 | 风险点 |
|-------|----------|----------|--------|
| TC-01 | 基本非结构化剪枝 | amount为float/int正确性 | 随机种子可重复性 |
| TC-02 | L1非结构化剪枝 | 重要性分数L1顺序 | 范数计算准确性 |
| TC-03 | 结构化剪枝 | dim参数通道选择 | 通道独立性验证 |
| TC-04 | 边界条件amount=0 | 无剪枝状态管理 | 缓冲区正确初始化 |
| TC-05 | 边界条件amount=全部 | 完全剪枝处理 | 零值参数梯度 |
| TC-06 | L2结构化剪枝 | Ln范数类型支持 | 不同n值计算 |
| TC-07 | 自定义重要性分数 | 外部分数优先级 | 分数形状验证 |
| TC-08 | 全局剪枝 | 多参数统一剪枝 | 跨参数重要性比较 |
| TC-09 | 剪枝移除功能 | 状态清理效果保留 | 缓冲区清理完整性 |
| TC-10 | 基类接口 | 抽象方法契约 | 子类实现要求 |

## 5. 尚未覆盖的风险点
- 迭代剪枝组合（PruningContainer）复杂行为
- 大模型内存使用监控和性能影响
- 剪枝后模型训练稳定性验证
- 序列化/反序列化后剪枝状态保持
- 梯度计算正确性（剪枝参数梯度应为0）
- 全局剪枝仅支持unstructured类型的限制验证