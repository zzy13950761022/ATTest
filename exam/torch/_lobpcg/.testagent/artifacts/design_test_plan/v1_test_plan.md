# torch._lobpcg 测试计划

## 1. 测试策略
- 单元测试框架：pytest
- 隔离策略：使用fixtures管理测试数据，mock tracker回调函数
- 随机性处理：固定随机种子确保可重复性，控制RNG生成初始X
- 设备支持：优先CPU测试，GPU作为扩展维度

## 2. 生成规格摘要（来自 test_plan.json）
- **SMOKE_SET**: CASE_01（密集矩阵基本求解）、CASE_02（最小特征值）、CASE_03（指定初始X）、CASE_06（稀疏矩阵）
- **DEFERRED_SET**: CASE_04（广义特征值）、CASE_05（批量处理）、CASE_07（迭代参数）、CASE_08（边界条件）、CASE_09（异常输入）、CASE_10（tracker回调）
- **group列表**: G1（基本功能验证）、G2（高级功能与边界测试）
- **active_group_order**: G1 → G2
- **断言分级策略**: 首轮仅使用weak断言（形状、数据类型、有限性、残差范数），后续启用strong断言（近似相等、正交性、特征值顺序）
- **预算策略**: 
  - S尺寸：max_lines≤80，max_params≤6
  - M尺寸：max_lines≤90，max_params≤7
  - 所有用例均参数化，仅CASE_10需要mock

## 3. 数据与边界
- **正常数据集**: 随机生成对称正定矩阵，尺寸4×4到8×8，k=1-4
- **随机生成策略**: 固定随机种子，使用torch.randn生成随机矩阵并对称化
- **边界值**: 
  - 最小尺寸：2×2矩阵，k=1
  - 最大k：k=m（所有特征值）
  - 批量维度：单矩阵 vs 批量矩阵
- **极端形状**: 
  - 大m小k：8×8矩阵求2个特征值
  - 小m大k：3×3矩阵求3个特征值（边界）
- **空输入**: 不适用（A为必需参数）
- **负例与异常场景**:
  1. 非对称矩阵输入
  2. 复数数据类型
  3. k>m（请求特征值超过矩阵维度）
  4. 非方阵输入
  5. 错误method参数值
  6. 维度不匹配的B矩阵
  7. 初始X维度错误

## 4. 覆盖映射
| TC ID | 需求/约束覆盖 | 优先级 | 备注 |
|-------|---------------|--------|------|
| TC-01 | 密集矩阵基本求解，largest=True | High | 核心路径 |
| TC-02 | 最小特征值求解，largest=False | High | 核心路径 |
| TC-03 | 指定初始特征向量X | High | 初始条件测试 |
| TC-04 | 广义特征值问题（B矩阵） | Medium | 参数扩展 |
| TC-05 | 批量矩阵处理 | Medium | 批量维度测试 |
| TC-06 | 稀疏矩阵特征值求解 | High | 稀疏矩阵支持 |
| TC-07 | 迭代参数控制 | Medium | 收敛性测试 |
| TC-08 | 边界条件测试 | Medium | 最小尺寸验证 |
| TC-09 | 异常输入验证 | Low | 错误处理 |
| TC-10 | tracker回调函数测试 | Low | 回调机制 |

## 5. 尚未覆盖的风险点
- 反向传播梯度计算（仅支持密集矩阵，B=None）
- 复数输入的限制
- 大尺寸矩阵（>100×100）的性能特征
- 病态矩阵的数值稳定性
- 正交方法参数字典的具体配置
- GPU设备的结果一致性
- 预处理器iK的使用场景