# torch._lobpcg 测试需求

## 1. 目标与范围
- 验证LOBPCG算法求解对称正定广义特征值问题的正确性
- 测试密集矩阵、稀疏矩阵和批量密集矩阵的特征值/向量计算
- 验证"basic"和"ortho"两种方法的实现一致性
- 不测试：非对称矩阵、复数输入的反向传播、外部依赖算法

## 2. 输入与约束
- A: Tensor, 尺寸(*, m, m), 对称矩阵, 必需
- k: int, 特征对数量, 默认X列数或1, 1 ≤ k ≤ m
- B: Tensor, 尺寸(*, m, m), 默认单位矩阵, 可选
- X: Tensor, 尺寸(*, m, n), 密集张量, k ≤ n ≤ m, 可选
- n: int, 随机特征向量大小, 默认k, 可选
- iK: Tensor, 尺寸(*, m, m), 预处理器, 可选
- niter: int, 最大迭代次数, -1表示无限, 可选
- tol: float, 残差容差, 默认feps**0.5, 可选
- largest: bool, True求最大特征值, 默认True, 可选
- method: str, "basic"或"ortho", 默认"ortho", 可选
- tracker: callable, 迭代跟踪函数, 默认None, 可选
- ortho_*params: dict, 正交方法参数, 可选

约束：
- A必须对称（自动对称化处理）
- X必须是密集张量
- 批量维度必须一致
- 稀疏矩阵仅支持前向传播

## 3. 输出与判定
- 返回: Tuple[Tensor, Tensor]
  - E: 特征值张量, 尺寸(*, k)
  - X: 特征向量张量, 尺寸(*, m, k)
- 容差: 默认基于数据类型浮点精度
- 验证: A @ X ≈ B @ X @ diag(E)
- 特征向量正交性: X^T @ B @ X ≈ I
- 状态变化: 无全局状态改变

## 4. 错误与异常场景
- 非法输入: 非对称A、复数输入、非方阵
- 维度不匹配: A与B尺寸不一致、X维度错误
- 类型错误: 非Tensor参数、错误数据类型
- 边界值: k=0、k>m、n<k、n>m
- 极端形状: 大m小k、小m大k、批量维度0
- 数值问题: 奇异B矩阵、病态矩阵
- 方法参数: 非"basic"/"ortho"的method值

## 5. 依赖与环境
- 外部依赖: 无网络/文件依赖
- 设备要求: CPU/GPU支持
- 需要mock: tracker回调函数
- 随机性: X未指定时生成随机初始向量
- 浮点精度: 不同dtype(float32/float64)的容差差异

## 6. 覆盖与优先级
- 必测路径（高优先级）：
  1. 密集矩阵基本特征值求解（largest=True/False）
  2. 稀疏矩阵前向传播验证
  3. 批量处理多组矩阵
  4. 指定初始X与随机初始化的结果一致性
  5. 两种method("basic"/"ortho")的等价性

- 可选路径（中/低优先级）：
  - 预处理器iK的使用
  - 不同容差tol的收敛性
  - 最大迭代次数niter限制
  - 正交方法参数字典配置
  - tracker回调函数的监控
  - 梯度计算验证（仅密集矩阵，B=None）
  - 极端批量维度(1, 大数量)
  - 不同设备(CPU/GPU)结果一致性

- 已知风险/缺失信息：
  - 反向传播不支持稀疏和复数输入
  - 仅B=None时支持梯度计算
  - 正交方法参数字典结构未详细说明
  - 算法收敛性未量化描述
  - 大尺寸矩阵的性能特征
  - 病态矩阵的数值稳定性