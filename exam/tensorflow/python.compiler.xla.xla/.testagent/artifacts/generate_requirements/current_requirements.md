# tensorflow.python.compiler.xla.xla 测试需求

## 1. 目标与范围
- 主要功能与期望行为
  - 验证 compile() 函数将 TensorFlow 计算图编译为 XLA 加速代码
  - 测试 computation 函数在 eager 模式下具有 @tf.function 语义
  - 验证返回结构与直接调用 computation(*inputs) 的一致性
  - 测试特殊输出处理：None 输出、单值输出、仅操作输出
  - 验证操作执行顺序：返回的操作在评估输出张量时执行
- 不在范围内的内容
  - 替代方案 tf.function(jit_compile=True) 的完整功能验证
  - XLA 编译器内部实现细节
  - 性能基准测试和优化效果评估

## 2. 输入与约束
- 参数列表（名称、类型/shape、默认值）
  - computation: Python 函数，接受 n 个输入，构建计算图
  - inputs: 列表或 None（默认值），每个输入为可转换为张量的嵌套结构
- 有效取值范围/维度/设备要求
  - inputs 可为空列表或 None（等价处理）
  - 支持 N 维兼容值列表，产生 N 维标量张量列表
  - 不支持单个 Rank-N 张量作为输入
  - 需要 XLA 兼容设备支持
- 必需与可选组合
  - computation 参数必需
  - inputs 参数可选，默认为 None
- 随机性/全局状态要求
  - 随机数操作在 XLA 编译中可能违反 TensorFlow 语义
  - 修改全局状态：变量作用域、摘要跳过函数

## 3. 输出与判定
- 期望返回结构及关键字段
  - 与直接调用 computation(*inputs) 相同的数据结构
  - None 输出：返回 NoOp，控制依赖于计算
  - 单值输出：返回包含该值的元组
  - 仅操作输出：返回 NoOp，控制依赖于计算
- 容差/误差界（如浮点）
  - 浮点计算精度与原生 TensorFlow 一致
  - 数值结果容差：相对误差 1e-6，绝对误差 1e-8
- 状态变化或副作用检查点
  - 验证操作执行顺序正确性
  - 检查全局状态修改（变量作用域）
  - 验证摘要操作被正确跳过

## 4. 错误与异常场景
- 非法输入/维度/类型触发的异常或警告
  - computation 不是可调用函数
  - inputs 不是列表或 None
  - 输入包含不支持的操作类型（Placeholder、Summary 操作等）
  - 输入维度不兼容
- 边界值（空、None、0 长度、极端形状/数值）
  - inputs=None 与 inputs=[] 等价性
  - 空计算函数
  - 极端形状输入（超大维度、零维度）
  - 数值边界（inf、nan、极大/极小值）

## 5. 依赖与环境
- 外部资源/设备/网络/文件依赖
  - XLA 编译器可用性
  - GPU/TPU 设备支持（如适用）
  - TensorFlow 版本兼容性
- 需要 mock/monkeypatch 的部分
  - XLA 编译失败场景模拟
  - 设备不可用情况
  - 全局状态修改的隔离测试

## 6. 覆盖与优先级
- 必测路径（高优先级，最多 5 条，短句）
  1. 基本 compile() 调用：有效 computation 和 inputs
  2. None 输入处理：inputs=None 和 inputs=[]
  3. 特殊输出验证：None 输出、单值输出、仅操作输出
  4. 嵌套输入结构转换测试
  5. 不支持操作异常触发
- 可选路径（中/低优先级合并为一组列表）
  - 多设备兼容性测试
  - 大规模计算图编译
  - 随机数操作语义验证
  - 性能回归基准
  - 与 tf.function(jit_compile=True) 行为对比
- 已知风险/缺失信息（仅列条目，不展开）
  - compile() 函数已弃用状态
  - 缺少详细类型注解
  - 随机数操作语义差异
  - 文档示例不完整
  - 错误处理信息有限