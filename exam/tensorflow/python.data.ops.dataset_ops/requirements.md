# tensorflow.python.data.ops.dataset_ops 测试需求

## 1. 目标与范围
- 测试 TensorFlow 数据集模块的核心功能：数据集创建、转换、迭代
- 验证 `DatasetV2` 类及其子类（TensorDataset, TensorSliceDataset, RangeDataset 等）的正确性
- 测试 map、filter、batch、shuffle 等数据转换操作的执行逻辑
- 不在范围内：TensorFlow 底层图执行引擎、分布式数据集、自定义数据集扩展

## 2. 输入与约束
- 参数：模块无直接参数，但包含的类和函数有独立参数
- 数据类型：支持 TensorFlow 张量、Python 列表、元组、字典、生成器
- 形状约束：数据集元素需保持一致的形状（batch 操作除外）
- 设备要求：支持 CPU/GPU 设备，数据自动在设备间传输
- 必需组合：数据集创建后必须指定元素类型和形状信息
- 随机性要求：shuffle 操作需要随机种子控制可重复性
- 全局状态：无全局状态依赖，但 shuffle 缓冲区有状态

## 3. 输出与判定
- 返回结构：数据集对象（DatasetV2 实例），支持迭代和转换
- 关键字段：element_spec（元素规范）、cardinality（基数）
- 容差：浮点运算误差在 1e-6 范围内可接受
- 状态变化：数据集迭代器位置状态、shuffle 缓冲区状态
- 副作用检查：文件句柄正确关闭、内存资源及时释放

## 4. 错误与异常场景
- 非法输入：非张量数据、类型不匹配、形状不一致
- 维度错误：空张量、零维张量、维度不匹配
- 类型错误：Python 原生类型未转换为张量
- 边界值：空数据集、单元素数据集、极大形状（>2^31-1）
- 极端数值：NaN、Inf、极大/极小浮点数
- 资源限制：内存不足、文件不存在、权限错误

## 5. 依赖与环境
- 外部依赖：TensorFlow 核心库、NumPy（可选）
- 设备依赖：CPU 必需，GPU 可选测试
- 文件依赖：文件数据集需要临时测试文件
- 需要 mock：文件 I/O、网络请求、随机数生成器
- 需要 monkeypatch：系统时间（用于缓存）、随机种子

## 6. 覆盖与优先级
- 必测路径（高优先级）：
  1. 从张量/列表创建数据集并验证元素规范
  2. map 操作正确应用函数并保持形状
  3. batch 操作正确分组并处理尾部不完整批次
  4. shuffle 操作随机性可控且不丢失数据
  5. 迭代器正确遍历所有元素并处理空数据集

- 可选路径（中/低优先级）：
  - filter 操作条件过滤
  - repeat 操作无限/有限重复
  - prefetch 操作异步预取
  - cache 操作内存/文件缓存
  - take/skip 操作子集选择
  - zip/concat 操作数据集组合
  - 嵌套结构数据集处理
  - 动态形状数据集
  - 稀疏张量数据集

- 已知风险/缺失信息：
  - 分布式数据集测试环境复杂
  - 自定义数据集扩展测试覆盖不全
  - 内存泄漏检测困难
  - 性能基准测试标准缺失
  - 图模式与 eager 模式行为差异